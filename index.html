<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/png" href="../src/icon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Happy Birthday</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6.1629159505/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>

    <style>
        :root { --bg-gradient: radial-gradient(circle at center, #1a0b1a 0%, #000000 100%); }
        body { 
            margin: 0; overflow: hidden; 
            background-color: #000000; background-image: var(--bg-gradient); 
            font-family: 'Noto Serif SC', serif; color: white; 
            user-select: none; -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; cursor: grab; }
        #canvas-container:active { cursor: grabbing; }
        
        /* 翻转卡片 */
        .flip-card { background-color: transparent; perspective: 1000px; }
        .flip-card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 1.2rem; overflow: hidden;
        }
        .flip-card-back { transform: rotateY(180deg); }

        /* UI 层 */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; box-sizing: border-box; transition: opacity 0.5s; }
        .interactive-element { pointer-events: auto; cursor: pointer; }
        .input_video { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        
        /* 启动页样式 */
        #start-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
            pointer-events: auto;
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        #start-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .start-card {
            background: rgba(20, 10, 20, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 105, 180, 0.3);
            box-shadow: 0 0 50px rgba(255, 105, 180, 0.2);
        }

        #blow-meter-container { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); width: 280px; height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; opacity: 0; transition: opacity 0.5s; }
        #blow-meter-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e 0%, #ff69b4 100%); border-radius: 10px; transition: width 0.1s linear; box-shadow: 0 0 15px #ff69b4; }
        #blow-hint { position: absolute; bottom: 18%; width: 100%; text-align: center; font-size: 14px; color: rgba(255,255,255,0.8); text-shadow: 0 2px 4px rgba(0,0,0,0.8); opacity: 0; transition: opacity 0.5s; }

        #surprise-layer { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 80; pointer-events: none; transition: background 0.5s ease; }
        #surprise-layer.hidden { display: none !important; }
        #surprise-layer.active { pointer-events: auto; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }

        .font-handwriting { font-family: 'Dancing Script', cursive; }
        .pop-in { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .safe-click-area { z-index: 90; position: relative; touch-action: manipulation; }
        .neon-text { text-shadow: 0 0 10px rgba(255,105,180,0.7), 0 0 20px rgba(255,105,180,0.5); }

        #floating-gift-btn {
            position: absolute; bottom: 30px; right: 30px; z-index: 200; width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 105, 180, 0.5);
            display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.4); animation: float-btn 3s ease-in-out infinite;
            transition: transform 0.3s, background 0.3s; pointer-events: auto;
        }
        #floating-gift-btn:hover { transform: scale(1.1) rotate(10deg); background: rgba(255, 105, 180, 0.3); }
        #floating-gift-btn.hidden { display: none !important; }
        @keyframes float-btn { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        #settings-panel {
            position: absolute; top: 80px; right: 20px; width: 140px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px;
            padding: 15px; z-index: 50; display: none; 
            flex-direction: column; gap: 10px; pointer-events: auto;
        }
        .color-control { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #ddd; }
        .color-control input { width: 30px; height: 20px; border: none; border-radius: 4px; cursor: pointer; background: transparent; }

        #top-banner {
            position: absolute; top: 18%; left: 0; width: 100%;
            text-align: center; pointer-events: none; z-index: 5;
            animation: float-banner 4s ease-in-out infinite;
        }
        #top-banner.hidden { display: none !important; }
        .banner-text {
            font-family: 'Dancing Script', cursive;
            background: linear-gradient(to right, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(0 0 10px rgba(255,192,203,0.8));
        }
        @keyframes float-banner { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        #protocol-warning {
            position: fixed; top: 0; left: 0; width: 100%; background: #ff4444; color: white;
            text-align: center; padding: 10px; z-index: 10000; font-size: 14px; display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        #cam-preview-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #cam-preview-container:hover {
            transform: scale(1.05);
            opacity: 1;
        }
        
        /* 手机端缩小手势识别框 */
        @media (max-width: 768px) {
            #cam-preview-container .glass-panel {
                padding: 1px;
            }
            #cam-preview-container .relative {
                width: 96px !important;
                height: 72px !important;
            }
            #cam-preview-container .text-center p {
                font-size: 7px !important;
            }
        }
        
        @keyframes neon-pulse {
            0%, 100% { text-shadow: 0 0 10px rgba(255,105,180,0.7), 0 0 20px rgba(255,105,180,0.5); }
            50% { text-shadow: 0 0 20px rgba(255,105,180,0.9), 0 0 30px rgba(255,105,180,0.7), 0 0 40px rgba(255,105,180,0.5); }
        }
        .neon-pulse { animation: neon-pulse 2s infinite; }

        /* 隐藏的日志容器 */
        #debug-console { display: none; }

        /* 滚动文字区域样式 */
        .scrollable-text {
            max-height: 240px; /* 限制高度 */
            overflow-y: auto;  /* 允许垂直滚动 */
            padding-right: 10px; /* 给滚动条留点空 */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(255,105,180,0.5) transparent; /* Firefox */
        }
        /* Chrome/Safari 滚动条样式 */
        .scrollable-text::-webkit-scrollbar {
            width: 4px;
        }
        .scrollable-text::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollable-text::-webkit-scrollbar-thumb {
            background-color: rgba(255, 105, 180, 0.5);
            border-radius: 10px;
        }

        /* ===== 里世界（友利奈绪宇宙）层级架构 ===== */
        #tomori-universe {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9000; background: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto; padding: 40px 20px; pointer-events: none;
        }
        #tomori-universe.active {
            opacity: 1;
            pointer-events: auto;
            display: flex;
        }
        #tomori-universe.hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        /* 星空背景容器 */
        #tomori-starfield {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }

        /* 内容容器 */
        #tomori-content {
            position: relative; z-index: 10; max-width: 800px;
            text-align: center; color: #e2e8f0;
        }

        /* 标题 */
        #tomori-title {
            font-family: 'Dancing Script', cursive;
            font-size: 3.5rem; margin-bottom: 30px;
            background: linear-gradient(to right, #a78bfa, #fbbf24, #a78bfa);
            -webkit-background-clip: text; background-clip: text;
            color: transparent; text-shadow: 0 0 20px rgba(167, 139, 250, 0.5);
        }

        /* 故事/祝福文本 */
        #tomori-story {
            font-size: 1.1rem; line-height: 1.8;
            margin-bottom: 40px; letter-spacing: 0.05em;
            max-height: 300px; overflow-y: auto;
            padding: 20px; background: rgba(30, 30, 60, 0.4);
            border-left: 3px solid rgba(167, 139, 250, 0.6);
            border-radius: 8px;
        }

        /* 按钮组 */
        #tomori-actions {
            display: flex; gap: 15px; justify-content: center;
            flex-wrap: wrap;
        }

        .tomori-btn {
            padding: 12px 28px; border: none; border-radius: 25px;
            font-size: 1rem; cursor: pointer; font-weight: bold;
            transition: all 0.3s;
            backdrop-filter: blur(8px);
        }

        .tomori-btn-primary {
            background: linear-gradient(135deg, #a78bfa, #fbbf24);
            color: #1a1a2e; box-shadow: 0 0 30px rgba(167, 139, 250, 0.6);
        }
        .tomori-btn-primary:hover {
            transform: scale(1.05); box-shadow: 0 0 50px rgba(167, 139, 250, 0.8);
        }

        .tomori-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0; border: 1px solid rgba(167, 139, 250, 0.5);
        }
        .tomori-btn-secondary:hover {
            background: rgba(167, 139, 250, 0.2); border-color: rgba(167, 139, 250, 0.8);
        }

        /* 悬浮重入按钮 */
        #tomori-re-enter-btn {
            position: fixed; bottom: 100px; right: 30px; z-index: 200;
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #fbbf24);
            border: none; color: white; font-size: 30px;
            cursor: pointer; box-shadow: 0 0 30px rgba(167, 139, 250, 0.6);
            display: none; align-items: center; justify-content: center;
            transition: all 0.3s; animation: tomori-float 3s ease-in-out infinite;
        }
        #tomori-re-enter-btn:hover {
            transform: scale(1.15); box-shadow: 0 0 50px rgba(167, 139, 250, 0.8);
        }
        @keyframes tomori-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ===== 第一幕：摄像机取景框 ===== */
        .tomori-stage {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            opacity: 1; transition: opacity 0.8s ease;
            z-index: 10;
        }
        .tomori-stage.hidden { opacity: 0; pointer-events: none; }
        .tomori-stage.active { opacity: 1; pointer-events: auto; }

        #tomori-stage-1 {
            background: rgba(0, 0, 0, 0.8);
        }
        #tomori-stage-2 {
            background: radial-gradient(ellipse at center, rgba(15, 23, 42, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 场景容器 */
        .scenes-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
        }

        /* 单个场景 */
        .story-scene {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .story-scene.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .story-scene.prev {
            transform: translateX(-100%);
        }

        /* 场景星空背景 */
        .scene-starfield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* 场景内容 */
        .scene-content {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        /* 故事卡片 - 单独展示 */
        .story-scene .story-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
            width: auto;
            max-width: 500px;
        }

        /* 导航指示点 */
        .scene-nav-dots {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 50;
        }

        .nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(167, 139, 250, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(167, 139, 250, 0.5);
        }

        .nav-dot.active {
            background: #a78bfa;
            box-shadow: 0 0 15px rgba(167, 139, 250, 0.8);
            transform: scale(1.3);
        }

        .nav-dot:hover {
            background: rgba(167, 139, 250, 0.6);
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .story-card {
                max-width: 90%;
                padding: 0 10px;
            }

            .polaroid {
                width: 160px;
                height: 200px;
                padding: 12px;
            }

            .polaroid-image {
                height: 120px;
                font-size: 3.5rem;
            }

            .polaroid-text {
                font-size: 11px;
            }

            .story-text {
                padding: 15px 20px;
                max-width: 95%;
            }

            .story-text h3 {
                font-size: 1.2rem;
                margin-bottom: 12px;
            }

            .story-text p {
                font-size: 0.9rem;
                line-height: 1.8;
            }

            .scene-nav-dots {
                bottom: 20px;
            }

            .easter-eggs-container {
                bottom: 60px;
                gap: 15px;
            }

            .easter-egg-btn {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            .story-card {
                gap: 15px;
            }

            .polaroid {
                width: 140px;
                height: 180px;
                padding: 10px;
            }

            .polaroid-image {
                height: 100px;
                font-size: 3rem;
            }

            .story-text {
                padding: 12px 15px;
            }

            .story-text h3 {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }

            .story-text p {
                font-size: 0.85rem;
                line-height: 1.7;
            }

            .nav-dot {
                width: 10px;
                height: 10px;
            }

            .easter-eggs-container {
                bottom: 50px;
                gap: 12px;
            }

            .easter-egg-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }

        #tomori-blur-field {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; filter: blur(8px); opacity: 0.6;
        }

        /* 摄像机取景框蒙版 */
        .camcorder-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: 
                linear-gradient(to right, rgba(0,0,0,0.4) 0%, transparent 5%, transparent 95%, rgba(0,0,0,0.4) 100%),
                linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, transparent 5%, transparent 95%, rgba(0,0,0,0.4) 100%);
            z-index: 2;
            border: 3px solid rgba(200, 200, 200, 0.3);
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.6);
        }
        .camcorder-mask::before {
            content: ''; position: absolute; top: 20px; left: 20px;
            width: 30px; height: 30px; border: 2px solid rgba(255,255,255,0.4);
            border-right: none; border-bottom: none;
        }
        .camcorder-mask::after {
            content: ''; position: absolute; bottom: 20px; right: 20px;
            width: 30px; height: 30px; border: 2px solid rgba(255,255,255,0.4);
            border-left: none; border-top: none;
        }

        /* REC 指示器 */
        .rec-indicator {
            position: absolute; top: 30px; right: 30px; z-index: 5;
            display: flex; align-items: center; gap: 8px;
            background: rgba(0, 0, 0, 0.6); padding: 8px 14px;
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px; color: #ff4444; font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        .rec-dot {
            width: 10px; height: 10px; background: #ff4444;
            border-radius: 50%; animation: rec-blink 1s infinite;
            box-shadow: 0 0 8px #ff4444;
        }
        @keyframes rec-blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0.3; } }

        /* 日期时间显示 */
        .datetime-display {
            position: absolute; bottom: 30px; left: 30px; z-index: 5;
            background: rgba(0, 0, 0, 0.6); padding: 8px 12px;
            border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px; color: #ccc; font-family: 'Courier New', monospace;
            letter-spacing: 0.05em;
        }

        /* 对焦提示 */
        .focus-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 3; text-align: center; font-size: 2.5rem;
            animation: focus-pulse 1.5s ease-in-out infinite;
            opacity: 1; transition: opacity 0.5s;
        }
        .focus-hint.hidden { opacity: 0; pointer-events: none; }
        @keyframes focus-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }

        /* 对焦完成消息 */
        .focus-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 3; text-align: center; font-size: 1.3rem;
            color: #a78bfa; opacity: 0; transition: opacity 0.8s;
            letter-spacing: 0.05em;
        }
        .focus-message.active { opacity: 1; }

        /* 第二幕摄像机蒙版 */
        .stage2-camcorder-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 40;
            pointer-events: none;
            background: 
                linear-gradient(to right, rgba(0,0,0,0.3) 0%, transparent 5%, transparent 95%, rgba(0,0,0,0.3) 100%),
                linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 5%, transparent 95%, rgba(0,0,0,0.3) 100%);
            border: 2px solid rgba(200, 200, 200, 0.2);
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.4);
        }

        /* 四角取景框标记 - 已隐藏 */
        .stage2-corner-tl,
        .stage2-corner-tr,
        .stage2-corner-bl,
        .stage2-corner-br {
            display: none;
        }

        /* 第二幕REC指示器 */
        .stage2-rec-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.4);
            font-size: 8px;
            color: #fbbf24;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            pointer-events: none;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
            opacity: 0.85;
        }

        .stage2-rec-dot {
            width: 5px;
            height: 5px;
            background: #fbbf24;
            border-radius: 50%;
            animation: rec-blink 1s infinite;
            box-shadow: 0 0 4px #fbbf24;
        }

        /* 第二幕日期时间显示 */
        .stage2-datetime-display {
            position: absolute;
            bottom: 5px;
            left: 5px;
            z-index: 50;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(167, 139, 250, 0.4);
            font-size: 7px;
            color: #a78bfa;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.02em;
            pointer-events: none;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
            opacity: 0.85;
        }

        @media (max-width: 768px) {
            .stage2-corner-tl,
            .stage2-corner-tr,
            .stage2-corner-bl,
            .stage2-corner-br {
                width: 30px;
                height: 30px;
                border-width: 2px;
            }

            .stage2-corner-tl,
            .stage2-corner-tr {
                top: 15px;
            }

            .stage2-corner-bl,
            .stage2-corner-br {
                bottom: 15px;
            }

            .stage2-corner-tl,
            .stage2-corner-bl {
                left: 15px;
            }

            .stage2-corner-tr,
            .stage2-corner-br {
                right: 15px;
            }

            .stage2-rec-indicator {
                top: 3px;
                right: 3px;
                padding: 1px 4px;
                font-size: 6px;
                gap: 2px;
                border-radius: 6px;
                opacity: 0.75;
            }

            .stage2-rec-dot {
                width: 4px;
                height: 4px;
            }

            .stage2-datetime-display {
                bottom: 3px;
                left: 3px;
                padding: 1px 4px;
                font-size: 6px;
                border-radius: 3px;
                opacity: 0.75;
            }
        }

        /* ===== 第二幕：彗星轨迹与故事 ===== */
        #tomori-starfield-main {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }

        #tomori-story-cards {
            position: relative; z-index: 10;
            width: 100%; max-width: 1400px;
            display: flex; flex-direction: row; gap: 40px;
            align-items: center; justify-content: center;
            min-height: 100vh; padding: 60px 20px;
            flex-wrap: wrap;
        }

        .story-card {
            position: relative;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
        }
        
        .story-card.active { 
            opacity: 1; 
            pointer-events: auto;
        }

        /* 摄像机取景框风格 */
        .polaroid {
            flex-shrink: 0;
            width: 280px;
            height: 210px;
            background: transparent;
            padding: 0;
            box-shadow: none;
            transform: none;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(167, 139, 250, 0.5);
            position: relative;
            backdrop-filter: blur(2px);
        }

        /* 摄像机四角标记 */
        .polaroid::before,
        .polaroid::after {
            content: '';
            position: absolute;
            border-color: rgba(251, 191, 36, 0.8);
            border-style: solid;
            pointer-events: none;
        }
        
        .polaroid::before {
            top: 8px;
            left: 8px;
            width: 30px;
            height: 30px;
            border-width: 3px 0 0 3px;
        }
        
        .polaroid::after {
            top: 8px;
            right: 8px;
            width: 30px;
            height: 30px;
            border-width: 3px 3px 0 0;
        }

        /* 下两个角的标记 */
        .polaroid-image::before,
        .polaroid-image::after {
            content: '';
            position: absolute;
            border-color: rgba(251, 191, 36, 0.8);
            border-style: solid;
            pointer-events: none;
            z-index: 10;
        }
        
        .polaroid-image::before {
            bottom: 8px;
            left: 8px;
            width: 30px;
            height: 30px;
            border-width: 0 0 3px 3px;
        }
        
        .polaroid-image::after {
            bottom: 8px;
            right: 8px;
            width: 30px;
            height: 30px;
            border-width: 0 3px 3px 0;
        }

        .polaroid-image {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            border-radius: 0;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            position: relative;
        }

        .polaroid-text {
            display: none;
        }

        /* 故事文本 */
        .story-text {
            color: #e2e8f0;
            text-align: left;
            padding: 20px 25px;
            max-width: 90%;
            width: 100%;
            max-width: 500px;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 15px;
            box-sizing: border-box;
        }

        .story-text h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #fbbf24;
            font-family: 'Dancing Script', cursive;
            word-break: break-word;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
            text-align: center;
        }

        .story-text p {
            font-size: 1rem;
            line-height: 1.9;
            letter-spacing: 0.02em;
            word-break: break-word;
            white-space: pre-line;
            margin: 0;
        }

        /* 彩蛋按钮容器 - 底部中心布局 */
        .easter-eggs-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 100;
        }

        .easter-egg-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 192, 203, 0.2);
            border: 2px solid rgba(255, 192, 203, 0.5);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .easter-egg-btn:hover {
            background: rgba(255, 192, 203, 0.4);
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.6);
        }

        @media (max-width: 768px) {
            .easter-eggs-container {
                bottom: 40px;
                gap: 15px;
            }

            .easter-egg-btn {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }
        }

        /* 心情急救包弹窗 */
        #heartfelt-aid-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 500; opacity: 0; pointer-events: none;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #heartfelt-aid-popup.active {
            opacity: 1; pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .aid-content {
            background: rgba(20, 10, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 3px solid rgba(255, 105, 180, 0.8);
            border-radius: 25px;
            padding: 40px 50px;
            text-align: center;
            box-shadow: 0 0 80px rgba(255, 105, 180, 0.6),
                        inset 0 0 50px rgba(167, 139, 250, 0.1);
            animation: popup-bounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90vw;
        }

        @media (max-width: 768px) {
            .aid-content {
                padding: 30px 25px;
                border-width: 2px;
                border-radius: 20px;
            }

            .aid-animation {
                width: 150px;
                height: 150px;
                margin-bottom: 15px;
            }

            .aid-text {
                font-size: 1.2rem;
                margin-bottom: 10px;
                letter-spacing: 0.05em;
                word-break: keep-all;
            }

            .aid-credit {
                font-size: 0.85rem;
            }
        }
        
        @keyframes popup-bounce {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .aid-animation {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            animation: kick-animation 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.6),
                        0 0 50px rgba(167, 139, 250, 0.4);
            border: 2px solid rgba(251, 191, 36, 0.6);
        }

        .aid-animation img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        @keyframes kick-animation {
            0% { 
                transform: scale(0) rotate(-45deg) translateX(-100px);
                opacity: 0;
            }
            60% { 
                transform: scale(1.2) rotate(10deg) translateX(15px);
                opacity: 1;
            }
            80% {
                transform: scale(0.95) rotate(-3deg) translateX(-5px);
            }
            100% { 
                transform: scale(1) rotate(0deg) translateX(0);
                opacity: 1;
            }
        }

        @keyframes shake-screen {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .aid-text {
            font-size: 1.6rem;
            color: #fbbf24;
            margin-bottom: 15px;
            font-weight: bold;
            font-family: 'Dancing Script', cursive;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.6),
                         0 0 30px rgba(255, 105, 180, 0.3);
            line-height: 1.6;
            animation: text-glow 1s ease-in-out infinite alternate;
        }
        
        @keyframes text-glow {
            from {
                text-shadow: 0 0 15px rgba(251, 191, 36, 0.6),
                             0 0 30px rgba(255, 105, 180, 0.3);
            }
            to {
                text-shadow: 0 0 20px rgba(251, 191, 36, 0.8),
                             0 0 40px rgba(255, 105, 180, 0.5);
            }
        }

        .aid-credit {
            font-size: 1rem;
            color: #a78bfa;
            font-style: italic;
            letter-spacing: 0.1em;
            opacity: 0.9;
        }

        /* 无限期陪伴券弹窗 */
        #voucher-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 500; opacity: 0; pointer-events: none;
            transition: all 0.8s ease;
        }
        #voucher-popup.active {
            opacity: 1; pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        #voucher-popup .aid-content {
            background: rgba(30, 20, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(167, 139, 250, 0.5);
            border-radius: 25px;
            padding: 40px 50px;
            text-align: center;
            box-shadow: 0 0 60px rgba(167, 139, 250, 0.4),
                        inset 0 0 30px rgba(251, 191, 36, 0.05);
            animation: popup-gentle-fade 0.8s ease;
            max-width: 90vw;
        }

        #voucher-popup .aid-animation {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            animation: gentle-zoom 0.8s ease;
            box-shadow: 0 0 30px rgba(167, 139, 250, 0.4),
                        0 0 50px rgba(251, 191, 36, 0.2);
            border: 2px solid rgba(167, 139, 250, 0.4);
        }

        @keyframes popup-gentle-fade {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes gentle-zoom {
            0% { 
                transform: scale(0.9);
                opacity: 0;
            }
            100% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        .voucher-text-container {
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .voucher-title {
            font-size: 1.8rem;
            color: #fbbf24;
            margin-bottom: 20px;
            font-weight: bold;
            font-family: 'Dancing Script', cursive;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
            line-height: 1.4;
        }

        .voucher-info {
            font-size: 1.1rem;
            color: #e2e8f0;
            margin-bottom: 10px;
            letter-spacing: 0.05em;
            line-height: 1.6;
        }

        .voucher-desc {
            font-size: 1.2rem;
            color: #e2e8f0;
            margin: 15px 0;
            font-weight: 500;
            line-height: 1.6;
            letter-spacing: 0.02em;
        }

        .voucher-credit {
            font-size: 1rem;
            color: #a78bfa;
            font-style: italic;
            letter-spacing: 0.08em;
            opacity: 0.9;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .download-voucher-btn {
            padding: 12px 30px;
            background: rgba(167, 139, 250, 0.3);
            border: 2px solid rgba(167, 139, 250, 0.6);
            border-radius: 25px;
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .download-voucher-btn:hover {
            background: rgba(167, 139, 250, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.6);
            color: #fff;
        }

        @media (max-width: 768px) {
            #voucher-popup .aid-content {
                padding: 30px 20px;
                border-width: 2px;
                border-radius: 20px;
                max-width: 85vw;
            }

            #voucher-popup .aid-animation {
                width: 160px;
                height: 160px;
                margin-bottom: 15px;
            }

            .voucher-text-container {
                padding: 0 5px;
                margin-bottom: 15px;
            }

            .voucher-title {
                font-size: 1.3rem;
                margin-bottom: 15px;
                word-break: keep-all;
                line-height: 1.5;
            }

            .voucher-info {
                font-size: 0.9rem;
                margin-bottom: 8px;
                letter-spacing: 0.03em;
                word-break: keep-all;
            }

            .voucher-desc {
                font-size: 1rem;
                margin: 12px 0;
                letter-spacing: 0.02em;
                word-break: keep-all;
                line-height: 1.7;
            }

            .voucher-credit {
                font-size: 0.85rem;
                letter-spacing: 0.05em;
                margin-bottom: 15px;
                word-break: keep-all;
                line-height: 1.7;
            }

            .download-voucher-btn {
                padding: 10px 20px;
                font-size: 0.85rem;
            }
        }

        /* 花火大会按钮 */
        .fireworks-btn {
            position: fixed;
            bottom: 30px;
            right: 110px;
            z-index: 200;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f97316);
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            animation: tomori-float 3s ease-in-out infinite;
        }

        .fireworks-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.8);
        }

        @keyframes gentle-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
            50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }
        }

        /* 花火场景 */
        .fireworks-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 600;
            background: linear-gradient(to bottom, #0a0e27 0%, #1a1a3e 50%, #2a2a5e 100%);
            opacity: 0;
            transition: opacity 0.8s ease;
            pointer-events: none;
        }

        .fireworks-scene.active {
            opacity: 1;
            pointer-events: auto;
        }

        #fireworks-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .fireworks-return-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 601;
            padding: 12px 24px;
            background: rgba(167, 139, 250, 0.2);
            border: 2px solid rgba(167, 139, 250, 0.5);
            border-radius: 10px;
            color: #a78bfa;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .fireworks-return-btn:hover {
            background: rgba(167, 139, 250, 0.3);
            transform: scale(1.05);
        }

        .fireworks-music-btn {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 601;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid rgba(251, 191, 36, 0.5);
            color: #fbbf24;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fireworks-music-btn:hover {
            background: rgba(251, 191, 36, 0.3);
            border-color: rgba(251, 191, 36, 0.7);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        /* 返回按钮 */
        .tomori-return-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 50;
            padding: 10px 24px;
            border: none;
            border-radius: 25px;
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid rgba(167, 139, 250, 0.5);
            transition: all 0.3s;
            backdrop-filter: blur(8px);
        }
        
        .tomori-return-btn:hover {
            background: rgba(167, 139, 250, 0.4);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.6);
        }

        @media (max-width: 768px) {
            .tomori-return-btn {
                top: 15px;
                left: 15px;
                padding: 8px 20px;
                font-size: 0.9rem;
            }
        }

        /* 音乐控制按钮 */
        .music-control-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(167, 139, 250, 0.2);
            border: 2px solid rgba(167, 139, 250, 0.5);
            color: #a78bfa;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .music-control-btn:hover {
            background: rgba(167, 139, 250, 0.4);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.6);
            transform: scale(1.1);
        }

        .music-control-btn.muted {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .music-control-btn {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }
        }

        /* 友利奈绪介绍过渡场景 */
        #tomori-intro-scene {
            position: absolute;
            inset: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.95);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease;
        }

        #tomori-intro-scene.active {
            opacity: 1;
            pointer-events: auto;
        }

        .intro-camera-frame {
            width: 80vw;
            max-width: 600px;
            height: 450px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(167, 139, 250, 0.6);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .intro-camera-frame.zoom-out {
            width: 280px;
            height: 210px;
            border: 2px solid rgba(167, 139, 250, 0.5);
            transform: none;
            max-width: none;
        }

        /* 缩放时角标也同步缩小 */
        .intro-camera-frame.zoom-out::before,
        .intro-camera-frame.zoom-out::after,
        .intro-camera-frame.zoom-out .intro-camera-content::before,
        .intro-camera-frame.zoom-out .intro-camera-content::after {
            width: 30px;
            height: 30px;
            border-width: 3px;
        }

        .intro-camera-frame.zoom-out::before {
            top: 8px;
            left: 8px;
        }

        .intro-camera-frame.zoom-out::after {
            top: 8px;
            right: 8px;
        }

        .intro-camera-frame.zoom-out .intro-camera-content::before {
            bottom: 8px;
            left: 8px;
        }

        .intro-camera-frame.zoom-out .intro-camera-content::after {
            bottom: 8px;
            right: 8px;
        }

        @media (max-width: 768px) {
            .intro-camera-frame.zoom-out {
                margin-top: calc(-105px - 30px);
            }
        }

        /* 介绍场景四角标记 */
        .intro-camera-frame::before,
        .intro-camera-frame::after {
            content: '';
            position: absolute;
            border-color: rgba(251, 191, 36, 0.8);
            border-style: solid;
            pointer-events: none;
        }
        
        .intro-camera-frame::before {
            top: 12px;
            left: 12px;
            width: 40px;
            height: 40px;
            border-width: 4px 0 0 4px;
        }
        
        .intro-camera-frame::after {
            top: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            border-width: 4px 4px 0 0;
        }

        .intro-camera-content {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .intro-camera-content::before,
        .intro-camera-content::after {
            content: '';
            position: absolute;
            border-color: rgba(251, 191, 36, 0.8);
            border-style: solid;
            pointer-events: none;
        }
        
        .intro-camera-content::before {
            bottom: 12px;
            left: 12px;
            width: 40px;
            height: 40px;
            border-width: 0 0 4px 4px;
        }
        
        .intro-camera-content::after {
            bottom: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            border-width: 0 4px 4px 0;
        }

        .intro-background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6;
        }

        .intro-dialogue-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, transparent 50%);
        }

        .intro-dialogue-text {
            color: #e2e8f0;
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: left;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9);
            font-family: 'Noto Serif SC', serif;
            white-space: pre-wrap;
            word-break: keep-all;
            letter-spacing: 0.03em;
        }

        .skip-intro-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 10px 20px;
            background: rgba(167, 139, 250, 0.3);
            border: 2px solid rgba(167, 139, 250, 0.6);
            border-radius: 25px;
            color: #e2e8f0;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 9999;
            pointer-events: auto;
        }

        .skip-intro-btn:hover {
            background: rgba(167, 139, 250, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.6);
            color: #fff;
        }
        
        .skip-intro-btn:active {
            transform: translateY(0px) scale(0.95);
        }

        @media (max-width: 768px) {
            .intro-camera-frame {
                width: 90vw;
                height: 400px;
            }

            .intro-dialogue-overlay {
                padding: 30px 15px;
            }

            .intro-dialogue-text {
                font-size: 0.88rem;
                line-height: 1.9;
                letter-spacing: 0.02em;
                word-break: keep-all;
                text-align: left;
                max-width: 100%;
                overflow-wrap: break-word;
            }

            .intro-camera-frame::before,
            .intro-camera-frame::after,
            .intro-camera-content::before,
            .intro-camera-content::after {
                width: 30px;
                height: 30px;
                border-width: 3px;
            }

            .skip-intro-btn {
                bottom: 20px;
                right: 20px;
                padding: 8px 16px;
                font-size: 0.85rem;
            }
        }

        /* 底层蛋糕内容淡出效果 */
        body.tomori-mode {
            overflow: hidden;
        }
        body.tomori-mode #canvas-container,
        body.tomori-mode #ui-layer {
            opacity: 0.3;
            pointer-events: none;
        }
    </style>
</head>
<body>
    
    <!-- 里世界：友利奈绪的祝福宇宙 -->
    <div id="tomori-universe" class="hidden">
        <!-- 友利奈绪介绍过渡场景 -->
        <div id="tomori-intro-scene">
            <div class="intro-camera-frame">
                <!-- REC指示器 -->
                <div class="stage2-rec-indicator intro-rec">
                    <span class="stage2-rec-dot"></span><span>REC</span>
                </div>
                <!-- 时间显示 -->
                <div class="stage2-datetime-display intro-datetime"></div>
                
                <div class="intro-camera-content">
                    <img src="./src/108.jpg" alt="友利奈绪" class="intro-background-image">
                    <div class="intro-dialogue-overlay">
                        <div class="intro-dialogue-text"></div>
                    </div>
                </div>
            </div>
            <!-- 跳过按钮 -->
            <button id="skip-intro-btn" class="skip-intro-btn">跳过 ⏭️</button>
        </div>

        <!-- 第一幕：摄像机取景框 -->
        <div id="tomori-stage-1" class="tomori-stage">
            <canvas id="tomori-blur-field"></canvas>
            <div class="camcorder-mask"></div>
            <div class="rec-indicator">
                <span class="rec-dot"></span><span>REC</span>
            </div>
            <div class="datetime-display"></div>
            <div class="focus-hint">比个✌️对焦</div>
            <div class="focus-message hidden">当我的镜头捕捉到你，世界才变得清晰。</div>
            
            <!-- 手势调试信息面板 -->
            <div id="gestureDebugPanel" style="position: absolute; bottom: 30px; left: 30px; color: #a78bfa; font-family: 'Courier New', monospace; font-size: 11px; background: rgba(15, 23, 42, 0.85); padding: 12px; border-radius: 6px; border: 1px solid #7c3aed; min-width: 280px; display: none; z-index: 50;">
                <div style="color: #fbbf24; margin-bottom: 6px; font-weight: bold;">📊 V手势检测</div>
                <div id="gestureIndexDist" style="margin: 3px 0;">食指-中指: --</div>
                <div id="gestureMiddleRingDist" style="margin: 3px 0;">中指-无名指: --</div>
                <div id="gestureIndexHeight" style="margin: 3px 0;">食指高度: --</div>
                <div id="gestureMiddleHeight" style="margin: 3px 0;">中指高度: --</div>
                <div id="gestureStatus" style="margin-top: 6px; color: #ff6b6b; font-weight: bold;">等待手势...</div>
            </div>
        </div>

        <!-- 第二幕：彗星轨迹与故事节点 -->
        <div id="tomori-stage-2" class="tomori-stage hidden">
            <!-- 摄像机蒙版层 -->
            <div class="stage2-camcorder-mask">
                <div class="stage2-corner-tl"></div>
                <div class="stage2-corner-tr"></div>
                <div class="stage2-corner-bl"></div>
                <div class="stage2-corner-br"></div>
            </div>
            
            <!-- REC指示器 和 日期时间显示 已移至每个polaroid-image内部 -->
            
            <!-- 场景容器 -->
            <div id="tomori-scenes-container" class="scenes-container">
                <!-- 场景1 -->
                <div class="story-scene" data-scene="0">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/13.gif" alt="场景1" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Lens</div>
                            </div>
                            <div class="story-text">
                                <h3>【取景框】</h3>
                                <p>（调整焦距）

镜头里的世界总是比现实更清晰一些。透过这个取景框，我记录下了你所有不经意的瞬间——

转笔时微蹙的眉，听歌时放空的眼神，还有那些你以为没人注意到的小表情。

这些画面，我都收藏好了。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景2 -->
                <div class="story-scene" data-scene="1">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/12.gif" alt="场景2" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Frequency</div>
                            </div>
                            <div class="story-text">
                                <h3>【耳机】</h3>
                                <p>（递过耳机的另一边）

有时候不需要多余的话，一副耳机就是最好的安慰。

左声道给你，右声道给我。我们可以什么都不说，就这样安静地把这首歌听完。

世界的喧嚣交给我来屏蔽，你只需要专注于旋律。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景3 -->
                <div class="story-scene" data-scene="2">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/4.gif" alt="场景3" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Flavor</div>
                            </div>
                            <div class="story-text">
                                <h3>【蛋包饭】</h3>
                                <p>（把盘子推过来）

虽然味道可能有点奇怪...但这是我亲手做的。

生活不总是甜的，有时候会像这盘蛋包饭一样，酸涩、笨拙，甚至有些失败。

但即使是这样的日子，只要有人陪你一起吃完，它就变得有意义了。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景4 -->
                <div class="story-scene" data-scene="3">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/15.gif" alt="场景4" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Memory</div>
                            </div>
                            <div class="story-text">
                                <h3>【回忆】</h3>
                                <p>（按下快门）

摄像机不会说谎，它只会忠实地记录下每一帧画面。

那天你穿粉色裙子的样子，阳光洒在你侧脸上的瞬间，还有你笑起来眼睛弯成月牙的模样...

这些珍贵的记忆，我已经全部存档了。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景5 -->
                <div class="story-scene" data-scene="4">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/8.gif" alt="场景5" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Melody</div>
                            </div>
                            <div class="story-text">
                                <h3>【旋律】</h3>
                                <p>（音量调小一格）

你说过喜欢Aimer的歌，喜欢《六等星の夜》里那种温柔又坚定的力量。

我不太懂音乐，但我知道，当旋律响起的时候，你的表情会变得很平静。

所以我会一直在这里，陪你听完每一首歌。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景6 -->
                <div class="story-scene" data-scene="5">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/16.gif" alt="场景6" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Sunset</div>
                            </div>
                            <div class="story-text">
                                <h3>【夕阳】</h3>
                                <p>（看着远方的天空）

那天的夕阳真的很美，金色的光晕把整个世界都染成了暖色调。

你说想把这一刻永远留住，所以我按下了快门。

虽然照片会褪色，但那个瞬间，已经被刻在了比胶片更可靠的地方——我的记忆里。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景7 -->
                <div class="story-scene" data-scene="6">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/14.gif" alt="场景7" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Courage</div>
                            </div>
                            <div class="story-text">
                                <h3>【勇气】</h3>
                                <p>（伸出手）

我知道你现在很累，觉得整个世界都在对你施压。

但是听好了——即使你倒下了，我也会把你扶起来。即使全世界都背对你，我也会站在你这边。

因为这是我的决定，不需要理由。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景8 -->
                <div class="story-scene" data-scene="7">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/2.gif" alt="场景8" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Warmth</div>
                            </div>
                            <div class="story-text">
                                <h3>【温暖】</h3>
                                <p>（递过毛毯）

我不擅长说那些温暖的话，也做不出完美的料理。

但如果你需要一个避风的地方，我可以挡在你前面。如果你需要有人陪，我就坐在你旁边不说话。

笨拙一点没关系，至少是真心的。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景9 -->
                <div class="story-scene" data-scene="8">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/9.gif" alt="场景9" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Silence</div>
                            </div>
                            <div class="story-text">
                                <h3>【沉默】</h3>
                                <p>（静静坐在旁边）

有些时刻，不需要任何语言。

就像镜头后的我，不会追问你为什么心情不好，只会默默记录下你的侧脸，然后把摄像机放下，坐在你身边。

陪伴本身，就是最好的答案。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景10 -->
                <div class="story-scene" data-scene="9">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/11.gif" alt="场景10" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Dream</div>
                            </div>
                            <div class="story-text">
                                <h3>【梦想】</h3>
                                <p>（放下摄像机）

这个世界没有超能力，我无法掠夺你的痛苦，也改变不了既定的命运。

但我可以做到的是——在每一个平凡的日子里，记录下你的笑容；在每一个艰难的时刻，站在你身后。

这就是我的「能力」。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景11 -->
                <div class="story-scene" data-scene="10">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/3.gif" alt="场景11" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Stars</div>
                            </div>
                            <div class="story-text">
                                <h3>【星空】</h3>
                                <p>（抬头看天空）

你说过，每一颗星星都代表一个愿望。

如果真是这样，那我的愿望很简单——希望你能一直保持现在这样，自由地笑，认真地活着。

虽然听起来有点老套...但这就是我想记录的「珍贵回忆」。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 场景12 -->
                <div class="story-scene" data-scene="11">
                    <canvas class="scene-starfield"></canvas>
                    <div class="scene-content">
                        <div class="story-card">
                            <div class="polaroid">
                                <div class="polaroid-image"><img src="./src/10.gif" alt="场景12" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>
                                <div class="polaroid-text">The Promise</div>
                            </div>
                            <div class="story-text">
                                <h3>【承诺】</h3>
                                <p>（收起摄像机，认真地看着你）

录了这么久，该说的也都说了。
我不会承诺给你一个完美的世界，因为那不现实。但我可以承诺，无论未来发生什么，镜头里都会有你的位置。

生日快乐。下次见面的时候...记得笑给我看。
最后奈绪我想邀请你去花火大会。</p>
                                <button class="tomori-btn" style="margin-top: 20px;" onclick="enterFireworksMode();">🎆 进入花火大会</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 导航指示 -->
            <div class="scene-nav-dots">
                <span class="nav-dot active" data-scene="0"></span>
                <span class="nav-dot" data-scene="1"></span>
                <span class="nav-dot" data-scene="2"></span>
                <span class="nav-dot" data-scene="3"></span>
                <span class="nav-dot" data-scene="4"></span>
                <span class="nav-dot" data-scene="5"></span>
                <span class="nav-dot" data-scene="6"></span>
                <span class="nav-dot" data-scene="7"></span>
                <span class="nav-dot" data-scene="8"></span>
                <span class="nav-dot" data-scene="9"></span>
                <span class="nav-dot" data-scene="10"></span>
                <span class="nav-dot" data-scene="11"></span>
            </div>

            <!-- 彩蛋按钮 -->
            <div class="easter-eggs-container">
                <button id="heartfelt-aid-btn" class="easter-egg-btn" title="丧的时候点我">🩹</button>
                <button id="voucher-btn" class="easter-egg-btn" title="万能兑换券">🎫</button>
            </div>

            <!-- 返回按钮 -->
            <button id="tomori-return-btn-2" class="tomori-return-btn">← 返回派对</button>
            
            <!-- 音乐控制按钮 -->
            <button id="music-control-btn" class="music-control-btn" title="音乐开/关">🎵</button>
        </div>

        <!-- 彩蛋：心情急救包动画 -->
        <div id="heartfelt-aid-popup">
            <div class="aid-content">
                <div class="aid-animation">
                    <img src="./src/17.gif" alt="友利奈绪飞踢">
                </div>
                <p class="aid-text">笨蛋！不准丧！给我打起精神来！</p>
                <p class="aid-credit">—— 友利奈绪</p>
            </div>
        </div>

        <!-- 彩蛋：无限期陪伴券 -->
        <div id="voucher-popup">
            <div class="aid-content">
                <div class="aid-animation">
                    <img src="./src/18.gif" alt="无限期陪伴">
                </div>
                <div class="voucher-text-container">
                    <p class="voucher-title">【无限期陪伴券】</p>
                    <p class="voucher-info">持有者：zj</p>
                    <p class="voucher-info">发行者：ycx</p>
                    <p class="voucher-info">效力：无论何时何地</p>
                    <p class="voucher-desc">此券可兑换"无条件的陪伴"一次</p>
                    <p class="voucher-credit">就像友利奈绪对乙坂有宇那样。</p>
                </div>
                <button id="download-voucher-btn" class="download-voucher-btn">📥 下载陪伴券</button>
            </div>
        </div>
    </div>

    <!-- 悬浮重入按钮 -->
    <button id="tomori-re-enter-btn" title="再次进入友利奈绪的祝福">✨</button>

    <!-- 花火大会按钮 -->
    <button id="fireworks-btn" class="fireworks-btn">🎆</button>

    <!-- 花火场景 -->
    <div id="fireworks-scene" class="fireworks-scene hidden">
        <canvas id="fireworks-canvas"></canvas>
        <button id="fireworks-return-btn" class="fireworks-return-btn">返回派对 🎉</button>
        <button id="fireworks-music-btn" class="fireworks-music-btn" title="音乐开/关">🎵</button>
    </div>

    <div id="debug-console"></div>

    <div id="protocol-warning">
        ⚠️ 检测到您直接打开了HTML文件 (file://)。<br>摄像头和麦克风将被拦截。<br>
        <b>请在 VS Code 中安装 "Live Server" 插件并使用 "Open with Live Server" 运行。</b>
    </div>

    <audio id="bgm" loop>
        <source src="./src/happy-birthday-155461.mp3" type="audio/mpeg">
    </audio>

    <video class="input_video" playsinline></video>
    <div id="canvas-container"></div>
    
    <button id="floating-gift-btn" class="hidden safe-click-area" title="查看祝福">🎁</button>

    <!-- 启动页 -->
    <div id="start-overlay">
        <div class="text-center max-w-md p-8 glass-panel start-card mx-4 animate-float">
            <h1 class="text-6xl mb-2 font-handwriting text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-400 drop-shadow-lg">Happy Birthday</h1>
            <!-- <h2 class="text-4xl mb-6 font-bold text-white tracking-widest neon-text">粉姐</h2> -->
            <div class="space-y-4 text-gray-200 text-lg mb-8 font-light">
                <p>👋 <b>对着镜头 举起双手</b> 唤醒魔法</p>
                <p>💨 <b>持续吹气</b> 许下心愿</p>
            </div>
            <button id="start-btn" class="safe-click-area px-12 py-4 bg-gradient-to-r from-pink-600 to-purple-700 rounded-full font-bold text-xl hover:scale-105 active:scale-95 transition transform shadow-[0_0_20px_rgba(255,105,180,0.5)] text-white border border-white/20 cursor-pointer z-50">
                进入魔法世界
            </button>
            <div id="loading-text" class="hidden mt-4 text-pink-300 text-sm">正在编织星光...</div>
        </div>
    </div>

    <div id="blow-hint"><p class="text-lg font-bold text-pink-200 mb-1">🎤 对着麦克风吹气</p><p class="text-xs text-gray-400">(如果麦克风不灵可以尝试电脑长按空格 · 手机长按屏幕)</p></div>
    <div id="blow-meter-container"><div id="blow-meter-bar"></div></div>

    <div id="top-banner" class="hidden">
        <h1 class="text-6xl md:text-8xl banner-text">Happy Birthday</h1>
        <p class="text-pink-200/70 text-lg mt-4 tracking-widest uppercase">Best Wishes for You</p>
    </div>

    <!-- UI 层 -->
    <div id="ui-layer" style="display: none;">
        <div class="flex justify-between items-start w-full">
            <div class="glass-panel px-4 py-2">
                <div id="status-dot" class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2 shadow-[0_0_8px_red]"></div>
                <span id="status-text" class="text-xs md:text-sm text-gray-300 tracking-wider">SYSTEM READY</span>
            </div>
            <div class="flex gap-2">
                <button id="settings-toggle" class="interactive-element p-3 glass-panel hover:bg-white/20 transition rounded-full active:scale-90 text-sm">🎨</button>
                <button id="music-btn" class="interactive-element p-3 glass-panel hover:bg-white/20 transition rounded-full active:scale-90">🎵</button>
            </div>
        </div>
        
        <div id="settings-panel">
            <div class="color-control"><span>底层颜色</span><input type="color" id="picker-bottom" value="#FF69B4"></div>
            <div class="color-control"><span>顶层颜色</span><input type="color" id="picker-top" value="#FFB6C1"></div>
            <div class="color-control"><span>奶油颜色</span><input type="color" id="picker-cream" value="#FFFFFF"></div>
        </div>

        <div id="center-instruction" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none w-full z-0">
            <div class="flex items-center justify-center gap-4 mb-2">
                <span id="hand-icon" class="text-6xl animate-bounce">👋</span>
                <h2 id="instruction-text" class="text-6xl md:text-8xl font-bold text-white neon-pulse transition-all duration-700">举起双手</h2>
            </div>
            <p id="sub-instruction" class="mt-4 text-xl md:text-2xl text-pink-200/80 font-light tracking-[0.3em]">让魔法发生</p>
            <!-- 自动倒数提示文字 -->
            <p id="auto-countdown-text" class="mt-4 text-sm text-pink-200/60 font-light tracking-wider animate-pulse hidden"></p>
        </div>

        <!-- 摄像头预览框 -->
        <div id="cam-preview-container" class="absolute bottom-6 left-6 z-50 opacity-90 hover:opacity-100">
            <div class="glass-panel p-2 rounded-xl border border-white/10 shadow-[0_8px_32px_rgba(0,0,0,0.5)]">
                <div class="relative w-36 h-28 bg-black/40 rounded-lg overflow-hidden border border-white/5">
                     <canvas id="output_canvas" width="160" height="120" class="w-full h-full object-cover transform scale-x-[-1]"></canvas>
                     <div class="absolute top-2 right-2 flex items-center gap-1 bg-black/60 px-1.5 py-0.5 rounded-full backdrop-blur-sm">
                        <div id="cam-status-dot" class="w-1.5 h-1.5 rounded-full bg-red-500 transition-colors duration-300"></div>
                        <span id="cam-status-text" class="text-[8px] text-red-400 font-mono">NO HAND</span>
                     </div>
                </div>
                <div class="text-center mt-1.5">
                    <p class="text-[10px] text-pink-200/70 tracking-widest uppercase scale-90">Camera View</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 惊喜层 -->
    <div id="surprise-layer" class="hidden">
        <button id="reveal-btn" class="safe-click-area hidden px-10 py-5 bg-white text-pink-600 rounded-full font-bold text-2xl shadow-[0_0_60px_rgba(255,105,180,0.8)] hover:scale-105 transition-transform duration-300 animate-float">🎁 打开贺卡</button>
        
        <!-- 卡片容器 -->
        <div id="flip-card-container" class="hidden flip-card w-full max-w-sm md:max-w-md aspect-[3/4] mx-6 pop-in">
            <div class="flip-card-inner">
                
                <!-- 正面：引导开启 -->
                <div class="flip-card-front glass-panel bg-gradient-to-br from-pink-500/40 to-purple-600/40 border border-white/30 p-1">
                    <div class="bg-black/80 rounded-[1rem] p-6 h-full flex flex-col backdrop-blur-md">
                        <div class="w-full aspect-[4/3] bg-gray-800 rounded-lg mb-6 overflow-hidden relative border border-white/10 shadow-inner">
                            <img src="https://bpic.588ku.com/Templet_origin_pic/05/19/43/8c971b1364922e551b4fbccb2d5719d2.jpg" class="w-full h-full object-cover" alt="Gift">
                            <div class="absolute bottom-3 left-4 text-white/90 font-handwriting text-2xl">Happy Birthday!</div>
                        </div>
                        <div class="text-center mt-auto mb-8">
                            <p class="text-gray-300 mb-6 font-light leading-relaxed">这不仅仅是一场数字烟花，<br>更是为你准备的专属时刻。</p>
                            <button id="next-surprise-btn" class="safe-click-area w-full py-3 bg-gradient-to-r from-pink-600 to-purple-700 rounded-xl font-bold text-white shadow-lg hover:brightness-110 active:scale-95 transition">What's the surprise? ✨</button>
                        </div>
                    </div>
                </div>

                <!-- 背面：祝福内容 (分页显示) -->
                <div class="flip-card-back glass-panel bg-gradient-to-br from-purple-500/40 to-blue-600/40 border border-white/30 p-1">
                    <div class="bg-black/90 rounded-[1rem] p-8 h-full flex flex-col items-center justify-center backdrop-blur-md">
                        
                        <!-- 第一页：生日祝福 (带照片) -->
                        <div id="card-page-1" class="w-full h-full flex flex-col">
                            <div class="mb-4 text-5xl animate-bounce text-center">💌</div>
                            <h3 class="text-2xl font-bold text-pink-300 mb-6 font-handwriting text-center">致最特别的你</h3>
                            <div id="typewriter-text-1" class="text-left text-gray-200 space-y-4 font-light leading-7 text-sm md:text-base border-l-2 border-pink-500/50 pl-4 mb-4 flex-grow scrollable-text"></div>
                            
                            <button id="to-page-2-btn" class="safe-click-area px-6 py-2 mt-auto rounded-full bg-white/10 text-pink-200 hover:bg-white/20 transition text-sm flex items-center justify-center mx-auto">
                                还有话对你说... <span class="ml-2">👉</span>
                            </button>
                        </div>

                        <!-- 第二页：快递信息 (纯文字，带滚动) -->
                        <div id="card-page-2" class="w-full h-full flex flex-col hidden">
                            <h3 class="text-xl font-bold text-purple-300 mb-4 font-handwriting text-center mt-2">祝你天天开心</h3>
                            <!-- 滚动区域 -->
                            <div id="typewriter-text-2" class="text-left text-gray-200 space-y-3 font-light leading-6 text-sm md:text-base border-l-2 border-purple-500/50 pl-4 mb-4 flex-grow scrollable-text h-full"></div>
                            
                            <div class="flex flex-col gap-3 mt-4">
                                <button id="enter-tomori-btn" class="safe-click-area px-8 py-3 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold hover:brightness-110 transition text-sm">
                                    🌌 友利奈绪的祝福
                                </button>
                                <button id="close-card-btn" class="safe-click-area px-8 py-2 rounded-full border border-white/30 text-gray-300 hover:bg-white/10 hover:text-white transition text-sm">
                                    收起卡片
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 调试日志工具 ---
        const debugConsole = document.getElementById('debug-console');
        function log(msg) {
            if (debugConsole) {
                const time = new Date().toLocaleTimeString();
                debugConsole.innerHTML += `[${time}] ${msg}<br>`;
            }
            console.log(msg);
        }

        const IS_MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (window.location.protocol === 'file:') {
            document.getElementById('protocol-warning').style.display = 'block';
        }

        // --- 全局变量与配置 ---
        const CAKE_THEME = { bottom: "#FF69B4", top: "#FFB6C1", cream: "#FFFFFF" };
        const VISUAL_CONFIG = { particleCount: IS_MOBILE ? 4000 : 7500, color: 0xff69b4, blowThreshold: 25, blowMaxDuration: 100 };
        const STATE = { INTRO: -1, IDLE: 0, COUNTDOWN: 1, CAKE: 2, BLOWING: 3, CELEBRATION: 4 };
        
        let currentState = STATE.INTRO;
        let interactionMode = 0; 
        
        let particlesData = [];
        let scene, camera, renderer, particleSystem;
        let time = 0;
        let shapeCache = {}; 
        let blowProgress = 0;
        let isSpacePressed = false; 
        let isTouching = false; 
        
        let rotationVelocity = 0;
        let isDragging = false;
        let previousMouseX = 0;
        let lastHandX = 0;
        let autoRotateSpeed = 0.005;

        // --- 自动倒数变量 ---
        let autoEntryTimer = null;
        let autoEntrySeconds = 10;
        
        let audioContext, analyser;
        const bgm = document.getElementById('bgm');

        // Tomori宇宙状态管理
        let tomoriMode = false;
        let tomoriCurrentStage = 1; // 1=摄像机取景框, 2=彗星轨迹故事
        let tomoriStarfieldAnimationId = null;
        let tomoriBlurFieldAnimationId = null;
        let currentNodeIndex = 0;
        let handGestureDetected = false;

        const ui = {
            startOverlay: document.getElementById('start-overlay'),
            uiLayer: document.getElementById('ui-layer'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            mainText: document.getElementById('instruction-text'),
            subText: document.getElementById('sub-instruction'),
            handIcon: document.getElementById('hand-icon'),
            blowMeter: document.getElementById('blow-meter-container'),
            blowBar: document.getElementById('blow-meter-bar'),
            blowHint: document.getElementById('blow-hint'),
            surpriseLayer: document.getElementById('surprise-layer'),
            revealBtn: document.getElementById('reveal-btn'),
            floatingGiftBtn: document.getElementById('floating-gift-btn'),
            cardContainer: document.getElementById('flip-card-container'), 
            nextBtn: document.getElementById('next-surprise-btn'),
            closeBtn: document.getElementById('close-card-btn'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsToggle: document.getElementById('settings-toggle'),
            topBanner: document.getElementById('top-banner'),
            startBtn: document.getElementById('start-btn'),
            loadingText: document.getElementById('loading-text'),
            camStatusDot: document.getElementById('cam-status-dot'),
            camStatusText: document.getElementById('cam-status-text'),
            // 卡片相关 UI
            page1: document.getElementById('card-page-1'),
            page2: document.getElementById('card-page-2'),
            toPage2Btn: document.getElementById('to-page-2-btn'),
            textContainer1: document.getElementById('typewriter-text-1'),
            textContainer2: document.getElementById('typewriter-text-2'),
            // 自动倒数文本
            autoCountdownText: document.getElementById('auto-countdown-text'),
            // 友利奈绪宇宙相关
            tomoriUniverse: document.getElementById('tomori-universe'),
            tomoriStage1: document.getElementById('tomori-stage-1'),
            tomoriStage2: document.getElementById('tomori-stage-2'),
            tomoriBlurField: document.getElementById('tomori-blur-field'),
            tomoriStarfieldMain: document.getElementById('tomori-starfield-main'),
            gestureDebugPanel: document.getElementById('gestureDebugPanel'),
            gestureIndexDist: document.getElementById('gestureIndexDist'),
            gestureMiddleRingDist: document.getElementById('gestureMiddleRingDist'),
            gestureIndexHeight: document.getElementById('gestureIndexHeight'),
            gestureMiddleHeight: document.getElementById('gestureMiddleHeight'),
            gestureStatus: document.getElementById('gestureStatus'),
            storyCards: document.querySelectorAll('.story-card'),
            focusHint: document.querySelector('.focus-hint'),
            focusMessage: document.querySelector('.focus-message'),
            gestureDebugPanel: document.getElementById('gestureDebugPanel'),
            gestureIndexDist: document.getElementById('gestureIndexDist'),
            datetimeDisplay: document.querySelector('.datetime-display'),
            stage2DatetimeDisplay: document.querySelector('.stage2-datetime-display'),
            heartfeltAidBtn: document.getElementById('heartfelt-aid-btn'),
            voucherBtn: document.getElementById('voucher-btn'),
            heartfeltAidPopup: document.getElementById('heartfelt-aid-popup'),
            voucherPopup: document.getElementById('voucher-popup'),
            downloadVoucherBtn: document.getElementById('download-voucher-btn'),
            musicControlBtn: document.getElementById('music-control-btn'),
            tomoriReturnBtn2: document.getElementById('tomori-return-btn-2'),
            tomoriReEnterBtn: document.getElementById('tomori-re-enter-btn'),
            enterTomoriBtn: document.getElementById('enter-tomori-btn'),
            fireworksBtn: document.getElementById('fireworks-btn'),
            fireworksScene: document.getElementById('fireworks-scene'),
            fireworksCanvas: document.getElementById('fireworks-canvas'),
            fireworksReturnBtn: document.getElementById('fireworks-return-btn'),
            fireworksMusicBtn: document.getElementById('fireworks-music-btn')
        };

        // 立即初始化 Three.js
        initThree();

        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;
            renderer = new THREE.WebGLRenderer({ antialias: !IS_MOBILE, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            preloadShapes();
            createParticles();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            const onStart = (x) => {
                if(interactionMode === 1) {
                    isDragging = true;
                    previousMouseX = x;
                    rotationVelocity = 0; 
                }
            };
            const onMove = (x) => {
                if(isDragging && interactionMode === 1) {
                    const delta = x - previousMouseX;
                    const sensitivity = IS_MOBILE ? 0.015 : 0.008; 
                    rotationVelocity = delta * sensitivity;
                    particleSystem.rotation.y += rotationVelocity;
                    previousMouseX = x;
                }
            };
            const onEnd = () => { isDragging = false; };

            container.addEventListener('mousedown', (e) => onStart(e.clientX));
            window.addEventListener('mousemove', (e) => onMove(e.clientX));
            window.addEventListener('mouseup', onEnd);

            container.addEventListener('touchstart', (e) => onStart(e.touches[0].clientX), {passive: false});
            window.addEventListener('touchmove', (e) => {
                if(isDragging) e.preventDefault(); 
                onMove(e.touches[0].clientX);
            }, {passive: false});
            window.addEventListener('touchend', onEnd);
            
            render();
        }

        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(VISUAL_CONFIG.particleCount * 3);
            const colors = new Float32Array(VISUAL_CONFIG.particleCount * 3);
            const sizes = new Float32Array(VISUAL_CONFIG.particleCount);
            particlesData = [];
            const c = new THREE.Color(VISUAL_CONFIG.color);

            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const x = (Math.random() - 0.5) * 300;
                const y = (Math.random() - 0.5) * 300;
                const z = (Math.random() - 0.5) * 200;
                positions[i * 3] = x; positions[i * 3 + 1] = y; positions[i * 3 + 2] = z;
                colors[i * 3] = c.r; colors[i * 3 + 1] = c.g; colors[i * 3 + 2] = c.b;
                sizes[i] = Math.random() * 2;
                particlesData.push({
                    current: new THREE.Vector3(x, y, z),
                    target: new THREE.Vector3(x, y, z),
                    baseTarget: new THREE.Vector3(x, y, z),
                    velocity: new THREE.Vector3(0, 0, 0),
                    type: 'bg', layer: null, targetColor: c.clone(),
                    noiseOffset: Math.random() * 100,
                    angle: Math.random() * Math.PI * 2, 
                    radius: 20 + Math.random() * 40,
                    orbitSpeed: (Math.random() - 0.5) * 0.02
                });
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            const material = new THREE.PointsMaterial({ size: 1.2, vertexColors: true, map: getCircleTexture(), transparent: true, opacity: 0.8, depthWrite: false, blending: THREE.AdditiveBlending });
            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
        }

        function getCircleTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=64;
            const ctx=c.getContext('2d');
            const g=ctx.createRadialGradient(32,32,0,32,32,32);
            g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(1,'rgba(255,255,255,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(c);
        }

        function getShapePoints(type, text) {
            const points = [];
            if (type === 'text') {
                const c = document.createElement('canvas'); c.width=250; c.height=250;
                const ctx=c.getContext('2d');
                ctx.font = 'bold 120px Arial';
                ctx.fillStyle = 'white'; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillText(text, 125, 125);
                const data = ctx.getImageData(0,0,250,250).data;
                const step = 2;
                // 手机端缩小倒计时数字，更精致
                const textScale = IS_MOBILE ? 1.5 : 2;
                for(let y=0; y<250; y+=step) {
                    for(let x=0; x<250; x+=step) {
                        if(data[(y*250+x)*4+3]>128) {
                            points.push({ vec: new THREE.Vector3((x-125)/3.5, -(y-125)/3.5, 0).multiplyScalar(textScale), type: 'text', color: new THREE.Color(0xffffff) });
                        }
                    }
                }
            } else if (type === 'cake') {
                // 手机端缩小蛋糕尺寸
                const scale = IS_MOBILE ? 0.7 : 1.0;
                const layers = [
                    {y: -16 * scale, r: 18 * scale, h: 10 * scale, type: 'bottom'}, 
                    {y: -6 * scale,  r: 13 * scale, h: 8 * scale,  type: 'top'}
                ];
                layers.forEach(l => {
                    // 手机端减少蛋糕层粒子，避免过于密集
                    for(let i=0; i<(IS_MOBILE?600:1500); i++) {
                        const theta = Math.random() * Math.PI * 2;
                        const r = l.r * (0.95 + Math.random()*0.05); 
                        const h = Math.random() * l.h;
                        points.push({ vec: new THREE.Vector3(r*Math.cos(theta), l.y+h, r*Math.sin(theta)), type: 'cake', layer: l.type });
                    }
                    // 手机端适当减少奶油粒子
                    for(let i=0; i<(IS_MOBILE?350:500); i++) {
                        const theta = Math.random() * Math.PI * 2;
                        const r = Math.random() * l.r;
                        points.push({ vec: new THREE.Vector3(r*Math.cos(theta), l.y+l.h, r*Math.sin(theta)), type: 'cake', layer: 'cream' });
                    }
                    // 保持装饰颗粒数量，增加炫酷效果
                    for(let i=0; i<(IS_MOBILE?200:100); i++) {
                        const theta = Math.random() * Math.PI * 2;
                        const r = l.r + 0.2 * scale;
                        const h = Math.random() * l.h;
                        const sprinkleColor = new THREE.Color().setHSL(Math.random(), 1, 0.6);
                        points.push({
                            vec: new THREE.Vector3(r*Math.cos(theta), l.y+h, r*Math.sin(theta)),
                            type: 'cake', color: sprinkleColor
                        });
                    }
                });
                const candleY = layers[1].y + layers[1].h;
                const candleHeight = 12 * scale;
                // 手机端适当减少蜡烛粒子
                for(let i=0; i<(IS_MOBILE?220:300); i++) {
                    const h = Math.random() * candleHeight;
                    const r = Math.random() * 0.8 * scale;
                    const theta = Math.random() * Math.PI * 2;
                    let col = (Math.sin(h*1.5 + theta)>0) ? new THREE.Color(0xFF0000) : new THREE.Color(0xFFFFFF);
                    points.push({ vec: new THREE.Vector3(r*Math.cos(theta), candleY+h, r*Math.sin(theta)), type: 'candle', color: col });
                }
                const flameY = candleY + candleHeight;
                const flameHeight = 7 * scale;
                // 手机端保持火焰粒子，火焰本身就是炫酷效果的重点
                for(let i=0; i<(IS_MOBILE?350:400); i++) {
                    const u = Math.random();
                    const h = u * flameHeight;
                    const r = (1-u) * 2.0 * Math.random() * scale;
                    const theta = Math.random() * Math.PI * 2;
                    let col = new THREE.Color(0xFFA500);
                    if(u<0.2) col.setHex(0x0000FF); else if(u>0.7) col.setHex(0xFF4500);
                    points.push({ vec: new THREE.Vector3(r*Math.cos(theta), flameY+h, r*Math.sin(theta)), type: 'flame', color: col });
                }
            }
            return points;
        }

        function preloadShapes() {
            setTimeout(() => {
                shapeCache['3'] = getShapePoints('text', '3');
                shapeCache['2'] = getShapePoints('text', '2');
                shapeCache['1'] = getShapePoints('text', '1');
                shapeCache['cake'] = getShapePoints('cake');
                ui.loadingText.style.display = 'none';
            }, 100);
        }

        function transitionTo(key) {
            const targets = shapeCache[key] || [];
            particlesData.forEach((p, i) => {
                if (i < targets.length) {
                    p.baseTarget.copy(targets[i].vec);
                    p.target.copy(targets[i].vec);
                    p.type = targets[i].type;
                    p.layer = targets[i].layer;
                    if(targets[i].color) {
                        p.targetColor = targets[i].color.clone();
                    } else {
                        p.targetColor = new THREE.Color(0xffffff); 
                    }
                    const force = 3;
                    p.current.add(new THREE.Vector3((Math.random()-0.5)*force, (Math.random()-0.5)*force, (Math.random()-0.5)*force));
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    const r = 40 + Math.random() * 40;
                    p.baseTarget.set(r*Math.cos(angle), (Math.random()-0.5)*60, r*Math.sin(angle));
                    p.target.copy(p.baseTarget);
                    p.type = 'bg';
                    p.layer = null;
                    p.targetColor = new THREE.Color(0x222222);
                }
            });
        }

        function updateParticles() {
            const positions = particleSystem.geometry.attributes.position.array;
            const colors = particleSystem.geometry.attributes.color.array;
            const sizes = particleSystem.geometry.attributes.size.array;
            time += 0.02;
            const blowInfluence = blowProgress / 100;

            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const p = particlesData[i];
                let target = p.target.clone();

                if (p.type === 'cake') {
                    if (p.layer === 'bottom') p.targetColor.set(CAKE_THEME.bottom);
                    else if (p.layer === 'top') p.targetColor.set(CAKE_THEME.top);
                    else if (p.layer === 'cream') p.targetColor.set(CAKE_THEME.cream);
                }

                if (currentState === STATE.INTRO) {
                    const angle = p.angle + time * 0.05;
                    const r = p.radius + Math.sin(time * 0.5 + i * 0.01) * 10;
                    target.x = Math.cos(angle) * r * 3;
                    target.z = Math.sin(angle) * r * 3;
                    target.y = p.baseTarget.y + Math.sin(time * 0.5 + target.x * 0.05) * 20; 
                    const hue = 0.8 + (Math.sin(time * 0.1 + target.x * 0.01) * 0.1); 
                    p.targetColor.setHSL(hue, 0.7, 0.6);
                }
                else if (currentState === STATE.CELEBRATION && p.type === 'bg') {
                    const angle = p.angle + time * 0.1 + p.orbitSpeed;
                    const r = p.radius + Math.sin(time + i) * 5;
                    target.x = Math.cos(angle) * r;
                    target.z = Math.sin(angle) * r;
                    target.y = p.baseTarget.y + Math.sin(time + p.noiseOffset) * 2;
                    const hue = 0.9 + (Math.sin(time + i * 0.01) * 0.05); 
                    p.targetColor.setHSL(hue, 0.8, 0.6);
                } 
                else if (currentState === STATE.IDLE) {
                    const angle = p.angle + time * 0.1;
                    const r = p.radius + Math.sin(time + i * 0.01)*2;
                    target.x = Math.cos(angle) * r;
                    target.z = Math.sin(angle) * r;
                    target.y = p.baseTarget.y + Math.sin(time + target.x * 0.05) * 5; 
                    p.targetColor.set(0x333333); 
                }

                if (p.type === 'flame') {
                    const noise = Math.sin(time * 6 + p.noiseOffset) * 0.6;
                    target.x += noise;
                    if (blowInfluence > 0.1 || currentState === STATE.CELEBRATION) {
                        // 火焰从明到暗，不向上飞
                        const fadeAmount = blowInfluence * 0.8;
                        if(currentState === STATE.CELEBRATION) {
                            // 庆祝时完全熄灭消失，变为纯黑色
                            p.targetColor.set(0x000000);
                        } else {
                            // 吹气时逐渐变暗
                            p.targetColor.lerp(new THREE.Color(0x222222), fadeAmount * 0.3);
                        }
                    }
                }

                p.current.lerp(target, 0.08);

                positions[i*3] = p.current.x;
                positions[i*3+1] = p.current.y;
                positions[i*3+2] = p.current.z;
                
                colors[i*3] += (p.targetColor.r - colors[i*3]) * 0.1;
                colors[i*3+1] += (p.targetColor.g - colors[i*3+1]) * 0.1;
                colors[i*3+2] += (p.targetColor.b - colors[i*3+2]) * 0.1;

                if (p.type === 'flame' && (blowInfluence > 0.1 || currentState === STATE.CELEBRATION)) {
                    // 吹蜡烛时火焰逐渐缩小并变暗
                    if(currentState === STATE.CELEBRATION) {
                        sizes[i] = 0; // 庆祝时完全消失
                    } else {
                        sizes[i] = Math.max(0.3, 1.5 * (1 - blowInfluence)); // 吹气时逐渐缩小
                    }
                } else {
                    sizes[i] = 1.2 + Math.sin(time + i) * 0.3;
                }
            }

            particleSystem.geometry.attributes.position.needsUpdate = true;
            particleSystem.geometry.attributes.color.needsUpdate = true;
            particleSystem.geometry.attributes.size.needsUpdate = true;
            
            if (interactionMode === 1) {
                if (!isDragging) {
                    rotationVelocity *= 0.96; 
                    particleSystem.rotation.y += rotationVelocity + autoRotateSpeed;
                }
            } else if (currentState !== STATE.IDLE && currentState !== STATE.INTRO) {
                particleSystem.rotation.y = Math.sin(time * 0.15) * 0.15;
            } else {
                particleSystem.rotation.y = 0;
            }
        }

        /* --- 业务逻辑 --- */
        let transitionLock = false;

        function startSequence() {
            if (currentState !== STATE.IDLE || transitionLock) return;
                        
            // 清除自动倒数计时器
            if (autoEntryTimer) {
                clearInterval(autoEntryTimer);
                autoEntryTimer = null;
            }
            ui.autoCountdownText.classList.add('hidden');

            log('检测到手势，开始倒计时序列');
            transitionLock = true;
            currentState = STATE.COUNTDOWN;
            ui.statusText.innerText = "GESTURE DETECTED";
            ui.statusText.className = "text-xs md:text-sm text-green-400 font-bold tracking-wider";
            ui.statusDot.className = "inline-block w-2 h-2 rounded-full bg-green-500 mr-2 shadow-[0_0_8px_#0f0]";
            ui.handIcon.style.display = 'none';
            let count = 3;
            ui.mainText.innerText = "";
            ui.subText.innerText = "";
            transitionTo('3');
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    transitionTo(count.toString());
                } else {
                    clearInterval(timer);
                    showCake();
                }
            }, 1200);
        }

        function showCake() {
            log('展示蛋糕，开启吹气检测');
            currentState = STATE.BLOWING;
            transitionTo('cake');
            // 手机端不自动弹出调色板
            if (!IS_MOBILE) {
                ui.settingsPanel.style.display = 'flex';
            }
            ui.mainText.innerText = "";
            ui.subText.innerText = "";
            ui.topBanner.classList.remove('hidden'); 
            ui.statusText.innerText = "MIC LISTENING...";
            ui.blowMeter.style.opacity = '1';
            ui.blowHint.style.opacity = '1';
        }

        function successCelebration() {
            log('许愿成功！播放庆祝动画');
            currentState = STATE.CELEBRATION;
            ui.statusText.innerText = "WISH GRANTED";
            ui.blowMeter.style.opacity = '0';
            ui.blowHint.style.opacity = '0';
            ui.settingsPanel.style.display = 'none';
            
            document.body.classList.add('shake-screen');
            setTimeout(() => document.body.classList.remove('shake-screen'), 500);

            particlesData.forEach(p => {
                if (p.type === 'cake' || p.type === 'candle' || p.type === 'ring') {
                    p.target.y += Math.sin(p.current.x * 0.5) * 0.5; 
                } else if (p.type !== 'flame') {
                    p.type = 'bg'; 
                }
            });

            setTimeout(() => {
                ui.surpriseLayer.classList.remove('hidden');
                ui.surpriseLayer.classList.add('active');
                ui.revealBtn.classList.remove('hidden');
            }, 1500);
        }

        document.getElementById('picker-bottom').addEventListener('input', (e) => CAKE_THEME.bottom = e.target.value);
        document.getElementById('picker-top').addEventListener('input', (e) => CAKE_THEME.top = e.target.value);
        document.getElementById('picker-cream').addEventListener('input', (e) => CAKE_THEME.cream = e.target.value);
        
        ui.settingsToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const display = ui.settingsPanel.style.display;
            ui.settingsPanel.style.display = (display === 'none' || display === '') ? 'flex' : 'none';
        });

        // 第一页祝福语
        const wishes_part1 = [
            "生日快乐！",
            "",
            "愿你的生命如这秋天的森林，",
            "不必追逐繁盛，",
            "只需一片落叶的从容。",
            "每一次飘零都不是终结，",
            "而是为了沉淀下来年更丰盈的色彩。",
            "愿你的新岁，温润而金黄。",
        ];

        // 第二页歉意与快递
        const wishes_part2 = [
            "陈路周说，夏天是用来相遇的。",
            "那天你穿了蓝色的裙子，",
            "我觉得天气很好。",
            "祝你笑口常开，健康无灾。",
            "",
            "哪怕友利奈绪的摄像机没电了，",
            "哪怕星星都睡着了，",
            "你依然是这里最值得被记录的风景。",
            "",
            "希望你喜欢这个小小的Surprise！🎉🎂🎈"
        ];

        function typeWriter(textArray, containerId, speed = 50) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            let lineIndex = 0;
            let charIndex = 0;

            function type() {
                if (lineIndex < textArray.length) {
                    const currentLine = textArray[lineIndex];
                    if (charIndex < currentLine.length) {
                        container.innerHTML += currentLine.charAt(charIndex);
                        charIndex++;
                        setTimeout(type, speed);
                    } else {
                        container.innerHTML += "<br>";
                        lineIndex++;
                        charIndex = 0;
                        setTimeout(type, 300);
                    }
                    // 自动滚动到底部
                    container.scrollTop = container.scrollHeight;
                }
            }
            type();
        }

        ui.revealBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.revealBtn.classList.add('hidden');
            ui.cardContainer.classList.remove('hidden');
        });

        // "What's the surprise" 按钮 -> 翻转到背面 (第一页)
        ui.nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.cardContainer.classList.add('flipped');
            // 显示第一页，隐藏第二页
            ui.page1.classList.remove('hidden');
            ui.page2.classList.add('hidden');
            setTimeout(() => typeWriter(wishes_part1, 'typewriter-text-1'), 400);
        });

        // "还有话对你说" 按钮 -> 切换到第二页
        ui.toPage2Btn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.page1.classList.add('hidden');
            ui.page2.classList.remove('hidden');
            // 重新触发第二页的打字机
            setTimeout(() => typeWriter(wishes_part2, 'typewriter-text-2', 30), 100);
        });

        ui.floatingGiftBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.floatingGiftBtn.classList.add('hidden'); 
            ui.surpriseLayer.classList.remove('hidden'); 
            ui.surpriseLayer.classList.add('active');
            interactionMode = 0;
            ui.cardContainer.classList.remove('hidden');
            ui.cardContainer.classList.remove('flipped');
            // 重置为第一页状态
            ui.page1.classList.remove('hidden');
            ui.page2.classList.add('hidden');
            // 隐藏友利奈绪和花火大会按钮
            ui.tomoriReEnterBtn.style.display = 'none';
            ui.fireworksBtn.style.display = 'none';
        });

        // "收起卡片" 按钮
        ui.closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.mainText.innerText = ""; 
            ui.surpriseLayer.classList.remove('active');
            ui.surpriseLayer.classList.add('hidden');    
            ui.floatingGiftBtn.classList.remove('hidden');
            // 显示友利奈绪祝福重入按钮和花火大会按钮
            ui.tomoriReEnterBtn.style.display = 'flex';
            ui.fireworksBtn.style.display = 'flex';
            
            interactionMode = 1; 
            transitionTo('cake'); 
            ui.statusText.innerText = "INTERACTIVE MODE: DRAG TO ROTATE";
            ui.typewriter.innerHTML = ""; 
            ui.topBanner.classList.remove('hidden');
        });

        
        // --- 自动倒数功能 ---
        function startAutoEntryCountdown() {
            autoEntrySeconds = 15;
            ui.autoCountdownText.classList.remove('hidden');
            ui.autoCountdownText.innerText = `若未检测到手势，${autoEntrySeconds}秒后自动开始...`;
            
            // 清除旧的计时器（如果存在）
            if (autoEntryTimer) clearInterval(autoEntryTimer);

            autoEntryTimer = setInterval(() => {
                autoEntrySeconds--;
                if (autoEntrySeconds > 0) {
                    ui.autoCountdownText.innerText = `若未检测到手势，${autoEntrySeconds}秒后自动开始...`;
                } else {
                    clearInterval(autoEntryTimer);
                    autoEntryTimer = null;
                    ui.autoCountdownText.classList.add('hidden');
                    // 只有在还是 IDLE 状态时才自动开始，防止用户刚好在此时触发了手势
                    if (currentState === STATE.IDLE) {
                        log('自动倒数结束，触发开始序列');
                        startSequence();
                    }
                }
            }, 1000);
        }

        // 按钮点击事件处理
        ui.startBtn.addEventListener('click', async function() {
            log('点击了进入按钮...');
            const btn = this;
            
            if (typeof Hands === 'undefined') {
                log('警告: MediaPipe 库加载延迟。');
            }

            btn.innerHTML = '<span class="animate-pulse">Loading...</span>';
            btn.disabled = true;
            ui.loadingText.style.display = 'block';
            
            try {
                fadeAudioIn();
                await initAudio();
                log('音频初始化成功');
            } catch(e) {
                log('音频初始化警告: ' + e);
                ui.statusText.innerText = "AUDIO/MIC LIMITED";
            }

            try {
                log('尝试启动摄像头...');
                await initCamera();
                log('摄像头启动成功');
            } catch (e) {
                log('摄像头/MediaPipe 失败: ' + e);
                ui.statusText.innerText = "CAMERA FAILED - USE SPACEBAR";
            }
            
            log('进入主界面...');
            currentState = STATE.IDLE;
            ui.startOverlay.classList.add('hidden');
            ui.uiLayer.style.display = 'flex';

            // 启动自动倒数
            startAutoEntryCountdown();
        });

        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                checkAudio();
            } catch (e) {
                log('麦克风权限被拒绝');
                ui.statusText.innerText = "MIC DENIED - USE TOUCH/SPACE";
                throw e;
            }
        }

        document.addEventListener('touchstart', (e) => {
            if(currentState === STATE.BLOWING && !e.target.closest('button') && !e.target.closest('input')) {
                isTouching = true;
            }
        }, {passive: false});

        document.addEventListener('touchend', () => isTouching = false);
        document.addEventListener('touchcancel', () => isTouching = false);
        document.addEventListener('keydown', (e) => { if(e.code === 'Space') isSpacePressed = true; });
        document.addEventListener('keyup', (e) => { if(e.code === 'Space') isSpacePressed = false; });

        function checkAudio() {
            requestAnimationFrame(checkAudio);
            if (currentState !== STATE.BLOWING) return;
            let volume = 0;
            if (analyser) {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                let sum = 0; for(let i=0; i<data.length; i++) sum += data[i];
                volume = sum / data.length;
            }
            if (volume > VISUAL_CONFIG.blowThreshold || isSpacePressed || isTouching) {
                isBlowing = true;
                blowProgress += 0.8; 
            } else {
                isBlowing = false;
                blowProgress -= 0.3; 
            }
            blowProgress = Math.max(0, Math.min(100, blowProgress));
            ui.blowBar.style.width = blowProgress + '%';
            if (blowProgress >= 100) successCelebration();
        }

        function fadeAudioIn() {
            const playPromise = bgm.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    log('背景音乐开始播放');
                }).catch(error => {
                    log('自动播放被阻止，等待用户交互');
                });
            }
            
            bgm.volume = 0;
            let vol = 0;
            const fade = setInterval(() => {
                vol += 0.05;
                if(vol >= 0.5) { vol = 0.5; clearInterval(fade); }
                bgm.volume = vol;
            }, 200);
        }
        
        document.getElementById('music-btn').addEventListener('click', () => {
            if (bgm.paused) bgm.play(); else bgm.pause();
        });

        let globalHands = null;
        let globalCamera = null;
        
        async function initCamera() {
            const video = document.getElementsByClassName('input_video')[0];
            
            if (typeof Hands === 'undefined' || typeof Camera === 'undefined') {
                console.error("MediaPipe 库未加载");
                return;
            }

            try {
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`});
                
                hands.setOptions({ 
                    maxNumHands: 1, 
                    modelComplexity: 0, 
                    minDetectionConfidence: 0.5, 
                    minTrackingConfidence: 0.5 
                });
                
                globalHands = hands;
                
                hands.onResults((results) => {
                    // 第一幕手势检测（在Tomori模式中）
                    if (tomoriMode && tomoriCurrentStage === 1 && results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        const landmarks = results.multiHandLandmarks[0];
                        if (checkStage1HandGesture(landmarks) && !handGestureDetected) {
                            console.log("✌ V手势检测成功！触发转场...");
                            handGestureDetected = true;
                            
                            // 清除自动进入倒计时
                            if (autoEnterTimer) {
                                clearInterval(autoEnterTimer);
                                autoEnterTimer = null;
                            }
                            
                            ui.focusHint.classList.add('hidden');
                            ui.focusMessage.innerHTML = '✌ 手势识别成功！';
                            ui.focusMessage.classList.add('active');
                            setTimeout(() => {
                                transitionToStage2();
                            }, 1500);
                        }
                    }

                    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        ui.camStatusDot.className = "w-1.5 h-1.5 rounded-full bg-green-400 shadow-[0_0_8px_#4ade80]";
                        ui.camStatusText.innerText = "DETECTED";
                        ui.camStatusText.className = "text-[8px] text-green-400 font-mono font-bold";
                        
                        if (currentState === STATE.IDLE) {
                            startSequence();
                        }
                        if (interactionMode === 1) {
                            const currentHandX = results.multiHandLandmarks[0][9].x; 
                            const delta = currentHandX - lastHandX;
                            if (Math.abs(delta) > 0.002) {
                                // 大幅提高手势控制灵敏度
                                rotationVelocity += delta * -0.4; 
                            }
                            lastHandX = currentHandX;
                        }
                    } else {
                        ui.camStatusDot.className = "w-1.5 h-1.5 rounded-full bg-red-500";
                        ui.camStatusText.innerText = "NO HAND";
                        ui.camStatusText.className = "text-[8px] text-red-400 font-mono";
                    }

                    const ctx = document.getElementById('output_canvas').getContext('2d');
                    ctx.clearRect(0, 0, 160, 120);
                    if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                         for (const l of results.multiHandLandmarks) {
                             drawConnectors(ctx, l, HAND_CONNECTIONS, {color: '#ff69b4', lineWidth: 2});
                         }
                    }
                });

                const camera = new Camera(video, { 
                    onFrame: async () => { 
                        if (globalHands) {
                            await globalHands.send({image: video});
                        }
                    }, 
                    width: 320, 
                    height: 240 
                });
                
                globalCamera = camera;
                await camera.start();
                console.log("✅ 摄像头和手势识别已启动");
                return camera;
            } catch (error) {
                console.error("初始化摄像头失败:", error);
                throw error;
            }
        }

        function render() {
            requestAnimationFrame(render);
            updateParticles();
            renderer.render(scene, camera);
        }

        // ========== 里世界：友利奈绪的祝福宇宙 ==========
        // 友利奈绪的祝福内容
        const tomoriBlessing = `
            即使只有一个人，
            我也要记录下这世界的真实。
            但今天，我想记录的
            不是世界...

            而是你。

            你说你喜欢友利奈绪的摄像机，
            喜欢徐栀和陈路周那种自然的爱情，
            喜欢Aimer的歌声。

            所以我想用最真诚的方式，
            去记录关于你的一切——

            那天你穿了蓝色的裙子，
            天气真的很好。

            你笑的时候眼睛会弯起来，
            有时候会心不在焉地转笔，
            喜欢听歌的时候盯着天空。

            这些小细节，
            就像《StarringChild》的歌词一样，
            值得被永远记录。

            生日快乐。

            不是那种虚伪的、模板的生日快乐，
            而是——真的，希望你开心的生日快乐。

            在你难过的时候，我就做你的《Brave Shine》；
            在你开心的时候，我就安安静静听你哼歌。

            既然收了我的祝福，
            以后不许不开心。

            ——陈路周
        `;

        // ===== 第一幕：摄像机取景框 =====
        function initBlurField() {
            const canvas = ui.tomoriBlurField;
            if (!canvas) return;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');

            const particles = [];
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    radius: Math.random() * 2 + 0.5,
                    opacity: Math.random() * 0.4 + 0.1
                });
            }

            function drawBlurField() {
                ctx.fillStyle = 'rgba(15, 23, 42, 0.08)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                particles.forEach((p) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                    ctx.fillStyle = `rgba(200, 200, 200, ${p.opacity})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                });

                tomoriBlurFieldAnimationId = requestAnimationFrame(drawBlurField);
            }

            tomoriBlurFieldAnimationId = requestAnimationFrame(drawBlurField);
        }

        // 更新日期时间显示
        function updateDateTimeDisplay() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const dateTimeStr = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            // 更新第一幕的日期时间
            if (ui.datetimeDisplay) {
                ui.datetimeDisplay.textContent = dateTimeStr;
            }
            
            // 更新第二幕的日期时间（原有的固定位置）
            if (ui.stage2DatetimeDisplay) {
                ui.stage2DatetimeDisplay.textContent = dateTimeStr;
            }
            
            // 更新所有polaroid内的时间显示
            const allDatetimeDisplays = document.querySelectorAll('.polaroid .stage2-datetime-display');
            allDatetimeDisplays.forEach(display => {
                display.textContent = dateTimeStr;
            });
            
            // 更新intro场景的时间显示
            const introDatetime = document.querySelector('.intro-datetime');
            if (introDatetime) {
                introDatetime.textContent = dateTimeStr;
            }
        }

        // 第一幕手势检测
        function checkStage1HandGesture(landmarks) {
            if (!landmarks || landmarks.length < 21) return false;
            
            // 显示调试面板
            if (ui.gestureDebugPanel) {
                ui.gestureDebugPanel.style.display = 'block';
            }
            
            // 检测V手势：食指和中指张开
            const indexTip = landmarks[8];      // 食指尖端
            const middleTip = landmarks[12];    // 中指尖端
            const ringTip = landmarks[16];      // 无名指尖端
            const indexMcp = landmarks[5];      // 食指掌指关节
            const middleMcp = landmarks[9];     // 中指掌指关节
            
            // 计算指尖之间的距离
            const indexMiddleDistance = Math.hypot(
                indexTip.x - middleTip.x,
                indexTip.y - middleTip.y
            );
            const middleRingDistance = Math.hypot(
                middleTip.x - ringTip.x,
                middleTip.y - ringTip.y
            );
            
            // 检查手指是否抬起（相对于掌心）
            const indexHeight = Math.abs(indexMcp.y - indexTip.y);
            const middleHeight = Math.abs(middleMcp.y - middleTip.y);
            
            // 更新调试信息（降低阈值让识别更容易）
            if (ui.gestureIndexDist) ui.gestureIndexDist.textContent = `食指-中指: ${indexMiddleDistance.toFixed(3)} ${indexMiddleDistance > 0.025 ? '✓' : '✗'}`;
            if (ui.gestureMiddleRingDist) ui.gestureMiddleRingDist.textContent = `中指-无名指: ${middleRingDistance.toFixed(3)} ${middleRingDistance < 0.06 ? '✓' : '✗'}`;
            if (ui.gestureIndexHeight) ui.gestureIndexHeight.textContent = `食指高度: ${indexHeight.toFixed(3)} ${indexHeight > 0.03 ? '✓' : '✗'}`;
            if (ui.gestureMiddleHeight) ui.gestureMiddleHeight.textContent = `中指高度: ${middleHeight.toFixed(3)} ${middleHeight > 0.03 ? '✓' : '✗'}`;
            
            // V手势判定（降低难度）：
            // 1. 食指和中指距离较大（张开）- 从0.04降到0.025
            // 2. 中指和无名指距离较小（并拢）- 从0.04放宽到0.06
            // 3. 手指抬起 - 从0.05降到0.03
            const isVGesture = indexMiddleDistance > 0.025 && 
                              middleRingDistance < 0.06 && 
                              indexHeight > 0.03 && 
                              middleHeight > 0.03;
            
            // 更新状态
            if (ui.gestureStatus) {
                if (isVGesture) {
                    ui.gestureStatus.textContent = '✅ V手势已检测！';
                    ui.gestureStatus.style.color = '#4ade80';
                } else {
                    ui.gestureStatus.textContent = '❌ 继续比V手势...';
                    ui.gestureStatus.style.color = '#ff6b6b';
                }
            }
            
            return isVGesture;
        }

        // 友利奈绪台词序列
        const tomoriDialogueSequence = [
            "(清嗓子) 喂——听得到吗？嗯，REC灯亮了。",
            "(叹了口气，把散落的头发别到耳后) 真是的……因为某人拜托我一定要录这段视频，我就破例一次好了。",
            "(眼神突然变得认真，凑近镜头) 虽然不知道你现在在哪里，在经历着什么……但在今天这个日子，我允许你稍微放松一下。",
            "(嘴角微微上扬，露出一闪而过的温柔笑容) 去吃点好吃的，去听喜欢的歌，去创造属于你的'珍贵回忆'吧。"
        ];

        // 打字机动画控制标志
        let isTypingActive = false;
        let currentTypingAbort = null;
        let currentDialogueIndex = 0;
        let isTypingCurrentLine = false;
        let skipCurrentTyping = false;
        let skipWaiting = false;

        // 打字机效果（支持点击跳过）
        async function typewriterEffect(element, text, speed = 30) {
            element.textContent = '';
            isTypingCurrentLine = true;
            skipCurrentTyping = false;
            
            for (let i = 0; i < text.length; i++) {
                // 检查是否需要跳过到完整文字
                if (skipCurrentTyping) {
                    element.textContent = text;
                    isTypingCurrentLine = false;
                    return;
                }
                
                // 检查是否需要中止
                if (currentTypingAbort && currentTypingAbort.aborted) {
                    isTypingCurrentLine = false;
                    return;
                }
                element.textContent += text[i];
                await new Promise(resolve => setTimeout(resolve, speed));
            }
            
            isTypingCurrentLine = false;
        }

        // 显示友利奈绪介绍过渡场景
        async function showIntroScene() {
            const introScene = document.querySelector('#tomori-intro-scene');
            const dialogueText = document.querySelector('.intro-dialogue-text');
            const introFrame = document.querySelector('.intro-camera-frame');
            const skipBtn = document.querySelector('#skip-intro-btn');
            
            if (!introScene || !dialogueText || !introFrame) return;
            
            // 如果已经在播放动画，先彻底终止
            if (isTypingActive) {
                if (currentTypingAbort) {
                    currentTypingAbort.aborted = true;
                }
                isTypingActive = false;
                currentTypingAbort = null;
                // 等待旧动画完全停止
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // 创建新的中止控制器
            currentTypingAbort = { aborted: false };
            isTypingActive = true;
            
            // 完全重置intro场景状态
            introFrame.classList.remove('zoom-out');
            dialogueText.textContent = '';
            introScene.style.opacity = '0';
            
            // 短暂延迟确保DOM更新
            await new Promise(resolve => setTimeout(resolve, 50));
            
            // 更新intro场景的时间显示
            updateDateTimeDisplay();
            
            // 显示介绍场景
            introScene.style.opacity = '1';
            
            // 跳过按钮功能 - 必须先绑定，确保优先级
            const handleSkip = (e) => {
                console.log('🚀 跳过按钮被点击！');
                e.preventDefault();
                e.stopPropagation();
                
                // 移除所有事件监听器
                if (skipBtn) {
                    skipBtn.removeEventListener('click', handleSkip);
                    skipBtn.removeEventListener('touchend', handleSkip);
                }
                
                // 中止当前动画
                if (currentTypingAbort) {
                    currentTypingAbort.aborted = true;
                }
                isTypingActive = false;
                
                // 立即淡出并进入第二幕
                introScene.style.opacity = '0';
                setTimeout(() => {
                    dialogueText.textContent = '';
                    currentTypingAbort = null;
                    transitionToStage2Direct();
                }, 300);
            };
            
            if (skipBtn) {
                console.log('✅ 绑定跳过按钮事件');
                skipBtn.addEventListener('click', handleSkip);
                skipBtn.addEventListener('touchend', handleSkip);
            }
            
            // 添加点击/触摸事件监听器（但要排除跳过按钮）
            const handleIntroClick = (e) => {
                // 如果点击的是跳过按钮，不处理
                if (e.target.id === 'skip-intro-btn' || e.target.closest('#skip-intro-btn')) {
                    console.log('检测到点击跳过按钮，不处理intro点击');
                    return;
                }
                
                if (isTypingCurrentLine) {
                    // 如果正在打字，立即显示完整文字
                    skipCurrentTyping = true;
                } else {
                    // 如果当前行已完成，跳过等待时间
                    skipWaiting = true;
                }
            };
            
            introScene.addEventListener('click', handleIntroClick);
            introScene.addEventListener('touchend', handleIntroClick);
            
            // 逐行显示台词
            for (let i = 0; i < tomoriDialogueSequence.length; i++) {
                currentDialogueIndex = i;
                skipWaiting = false;
                
                // 检查是否被中止
                if (currentTypingAbort && currentTypingAbort.aborted) {
                    introScene.removeEventListener('click', handleIntroClick, true);
                    introScene.removeEventListener('touchend', handleIntroClick, true);
                    return;
                }
                
                // 显示当前台词
                await typewriterEffect(dialogueText, tomoriDialogueSequence[i], 30);
                
                // 检查是否被中止
                if (currentTypingAbort && currentTypingAbort.aborted) {
                    introScene.removeEventListener('click', handleIntroClick, true);
                    introScene.removeEventListener('touchend', handleIntroClick, true);
                    return;
                }
                
                // 如果不是最后一行，等待0.5秒（除非点击跳过）
                if (i < tomoriDialogueSequence.length - 1) {
                    const waitStart = Date.now();
                    while (Date.now() - waitStart < 500) {
                        if (skipWaiting) break;
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
            }
            
            // 移除点击监听器
            introScene.removeEventListener('click', handleIntroClick);
            introScene.removeEventListener('touchend', handleIntroClick);
            
            // 移除跳过按钮监听器
            if (skipBtn) {
                skipBtn.removeEventListener('click', handleSkip);
                skipBtn.removeEventListener('touchend', handleSkip);
            }
            
            // 等待0.5秒后开始淡出过渡
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 淡出过渡
            introScene.style.opacity = '0';
            
            // 等待淡出动画完成后进入第二幕
            setTimeout(() => {
                // 重置intro场景状态
                dialogueText.textContent = '';
                isTypingActive = false;
                currentTypingAbort = null;
                transitionToStage2Direct();
            }, 800);
        }

        // 从第一幕转向友利奈绪介绍场景
        function transitionToStage2() {
            ui.tomoriStage1.classList.add('hidden');
            
            // 切换音乐
            if (bgm.src && !bgm.src.includes('danxiangsi.mp3')) {
                bgm.pause();
                bgm.currentTime = 0;
            }
            
            // 显示介绍过渡场景
            setTimeout(() => {
                showIntroScene();
            }, 300);
        }

        // 友利奈绪介绍场景 -> 第二幕直接转场
        function transitionToStage2Direct() {
            ui.tomoriStage2.classList.remove('hidden');
            tomoriCurrentStage = 2;
            
            // 初始化星空和故事卡片
            setTimeout(() => {
                initMainStarfield();
                currentNodeIndex = 0;
                activateNode(0);
            }, 300);
        }

        // ===== 第二幕：彗星轨迹与故事 =====
        let cameraProgressZ = 0;
        let targetCameraProgressZ = 0;
        
        // 为每个polaroid添加REC和时间显示
        function addCamcorderOverlayToPolaroids() {
            const polaroids = document.querySelectorAll('.polaroid');
            polaroids.forEach((polaroid, index) => {
                // 避免重复添加
                if (polaroid.querySelector('.stage2-rec-indicator')) return;
                
                // 添加REC指示器
                const recIndicator = document.createElement('div');
                recIndicator.className = 'stage2-rec-indicator';
                recIndicator.innerHTML = '<span class="stage2-rec-dot"></span><span>REC</span>';
                polaroid.appendChild(recIndicator);
                
                // 添加时间显示
                const datetimeDisplay = document.createElement('div');
                datetimeDisplay.className = 'stage2-datetime-display';
                polaroid.appendChild(datetimeDisplay);
            });
        }
        
        function initMainStarfield() {
            // 获取所有场景容器和Canvas元素
            const scenes = document.querySelectorAll('.story-scene');
            const canvases = document.querySelectorAll('.scene-starfield');
            
            if (canvases.length === 0) {
                console.warn('未找到场景Canvas元素');
                return;
            }
            
            // 如果已经初始化过，先清理旧的动画
            if (window.starfields && window.starfields.length > 0) {
                window.starfields.forEach(field => {
                    if (field.animationId) {
                        cancelAnimationFrame(field.animationId);
                    }
                });
            }
            
            // 为所有polaroid-image添加摄像机覆盖层
            addCamcorderOverlayToPolaroids();

            // 为每个Canvas初始化星空
            const starfields = [];
            canvases.forEach((canvas, sceneIndex) => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                const ctx = canvas.getContext('2d');
                const stars = [];
                
                // 为每个场景创建独立的星星
                for (let i = 0; i < 500; i++) {
                    const depth = Math.random(); // 0-1，0是远处，1是近处
                    const starType = Math.random();
                    let color;
                    
                    // 星星颜色分布：70%白色，20%蓝色，10%紫色
                    if (starType < 0.7) {
                        color = { r: 226, g: 232, b: 240 }; // 白色
                    } else if (starType < 0.9) {
                        color = { r: 147, g: 197, b: 253 }; // 蓝色
                    } else {
                        color = { r: 196, g: 181, b: 253 }; // 紫色
                    }
                    
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        radius: (Math.random() * 1.2 + 0.3) * (0.5 + depth * 0.8), // 近处星星更大
                        opacity: Math.random() * 0.6 + 0.4,
                        twinkleSpeed: (Math.random() * 0.02 + 0.005) * (0.8 + depth * 0.4),
                        baseOpacity: Math.random() * 0.6 + 0.4,
                        color: color,
                        depth: depth,
                        vx: (Math.random() - 0.5) * 0.1 * depth, // 近处星星移动更快
                        vy: (Math.random() - 0.5) * 0.1 * depth
                    });
                }
                
                starfields.push({
                    canvas,
                    ctx,
                    stars,
                    sceneIndex,
                    animationId: null
                });
            });

            // 初始激活第一个场景
            currentNodeIndex = 0;
            updateSceneVisibility();

            // 启动所有Canvas的渲染
            starfields.forEach(field => {
                renderStarfield(field);
            });

            // 保存starfields以便后续更新
            window.starfields = starfields;
        }

        function renderStarfield(field) {
            const { canvas, ctx, stars, sceneIndex } = field;
            const isActive = sceneIndex === currentNodeIndex;
            
            // 深邃的星空背景渐变
            const bgGradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, canvas.width * 0.8
            );
            bgGradient.addColorStop(0, 'rgba(15, 23, 42, 0.05)');
            bgGradient.addColorStop(0.5, 'rgba(15, 23, 42, 0.08)');
            bgGradient.addColorStop(1, 'rgba(10, 15, 30, 0.12)');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 绘制彗星轨迹
            const cometProgress = (Date.now() % 8000) / 8000;
            const cometX = canvas.width * cometProgress;
            const cometY = canvas.height * 0.3;
            
            // 彗星轨迹线
            ctx.strokeStyle = 'rgba(251, 191, 36, 0.15)';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(0, cometY);
            ctx.lineTo(canvas.width, cometY);
            ctx.stroke();

            // 彗星头部 - 在活跃场景中更亮
            const cometOpacity = isActive ? 0.8 : 0.5;
            const gradient = ctx.createRadialGradient(cometX, cometY, 0, cometX, cometY, 20);
            gradient.addColorStop(0, `rgba(251, 191, 36, ${cometOpacity})`);
            gradient.addColorStop(1, 'rgba(251, 191, 36, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(cometX, cometY, 20, 0, Math.PI * 2);
            ctx.fill();

            // 绘制当前场景的节点指示（发光点）
            const nodeX = canvas.width * 0.5;
            const nodeY = canvas.height * 0.3;
            
            if (isActive) {
                // 活跃节点 - 强烈的发光和脉动
                const glowGradient = ctx.createRadialGradient(nodeX, nodeY, 0, nodeX, nodeY, 100);
                glowGradient.addColorStop(0, 'rgba(251, 191, 36, 0.4)');
                glowGradient.addColorStop(0.5, 'rgba(251, 191, 36, 0.1)');
                glowGradient.addColorStop(1, 'rgba(251, 191, 36, 0)');
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(nodeX, nodeY, 100, 0, Math.PI * 2);
                ctx.fill();

                // 脉动环
                const pulseSize = 20 + Math.sin(Date.now() / 200) * 10;
                ctx.strokeStyle = 'rgba(251, 191, 36, 0.8)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(nodeX, nodeY, pulseSize, 0, Math.PI * 2);
                ctx.stroke();
                
                // 中心点
                ctx.fillStyle = 'rgba(251, 191, 36, 1)';
                ctx.beginPath();
                ctx.arc(nodeX, nodeY, 5, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // 非活跃节点 - 淡出的指示
                const dimGradient = ctx.createRadialGradient(nodeX, nodeY, 0, nodeX, nodeY, 50);
                dimGradient.addColorStop(0, 'rgba(167, 139, 250, 0.2)');
                dimGradient.addColorStop(1, 'rgba(167, 139, 250, 0)');
                ctx.fillStyle = dimGradient;
                ctx.beginPath();
                ctx.arc(nodeX, nodeY, 50, 0, Math.PI * 2);
                ctx.fill();
            }

            // 绘制星星 - 闪烁和漂移效果
            stars.forEach((star) => {
                // 柔和的闪烁
                star.opacity += star.twinkleSpeed;
                if (star.opacity > star.baseOpacity + 0.4 || star.opacity < star.baseOpacity - 0.3) {
                    star.twinkleSpeed *= -1;
                }
                
                // 缓慢漂移
                star.x += star.vx;
                star.y += star.vy;
                
                // 边界处理（循环）
                if (star.x < 0) star.x = canvas.width;
                if (star.x > canvas.width) star.x = 0;
                if (star.y < 0) star.y = canvas.height;
                if (star.y > canvas.height) star.y = 0;

                const starOpacity = isActive ? star.opacity : star.opacity * 0.6;
                
                // 为较大的星星添加光晕
                if (star.radius > 1 && star.depth > 0.6) {
                    const haloGradient = ctx.createRadialGradient(
                        star.x, star.y, 0,
                        star.x, star.y, star.radius * 3
                    );
                    haloGradient.addColorStop(0, `rgba(${star.color.r}, ${star.color.g}, ${star.color.b}, ${starOpacity * 0.3})`);
                    haloGradient.addColorStop(1, `rgba(${star.color.r}, ${star.color.g}, ${star.color.b}, 0)`);
                    ctx.fillStyle = haloGradient;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius * 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // 星星主体
                ctx.fillStyle = `rgba(${star.color.r}, ${star.color.g}, ${star.color.b}, ${Math.min(1, starOpacity)})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fill();
            });

            // 继续动画
            field.animationId = requestAnimationFrame(() => renderStarfield(field));
        }

        function updateSceneVisibility() {
            const scenes = document.querySelectorAll('.story-scene');
            const navDots = document.querySelectorAll('.nav-dot');
            
            scenes.forEach((scene, index) => {
                if (index === currentNodeIndex) {
                    scene.classList.add('active');
                    scene.classList.remove('prev');
                } else if (index < currentNodeIndex) {
                    scene.classList.remove('active');
                    scene.classList.add('prev');
                } else {
                    scene.classList.remove('active', 'prev');
                }
            });

            // 更新导航点
            navDots.forEach((dot, index) => {
                if (index === currentNodeIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // 激活故事卡片节点 - 场景切换
        function activateNode(index) {
            const newIndex = Math.max(0, Math.min(index, 11));
            if (newIndex === currentNodeIndex) return;
            
            currentNodeIndex = newIndex;
            updateSceneVisibility();
        }

        // 事件监听器存储，防止重复注册
        let interactionListenersAdded = false;
        
        // 处理故事卡片的滚轮和滑动 - 带节流防止快速切换
        function setupStoryCardInteraction() {
            // 如果已经注册过，直接返回
            if (interactionListenersAdded) {
                return;
            }
            
            let touchStartX = 0;
            let touchStartY = 0;
            let isTransitioning = false;
            const transitionDelay = 800; // 毫秒
            const swipeThreshold = 50; // 滑动阈值（像素）
            
            // 导航点点击事件
            const navDots = document.querySelectorAll('.nav-dot');
            navDots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    if (!isTransitioning) {
                        isTransitioning = true;
                        activateNode(index);
                        setTimeout(() => { isTransitioning = false; }, transitionDelay);
                    }
                });
            });
            
            // 滚轮事件 - 左右滚动切换场景
            ui.tomoriStage2.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (isTransitioning) return;
                
                // 支持横向滚动（Shift + 滚轮 或 触摸板横向滑动）
                const deltaX = e.deltaX;
                const deltaY = e.deltaY;
                
                // 优先检测横向滚动
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    if (deltaX > 0 && currentNodeIndex < 11) {
                        isTransitioning = true;
                        activateNode(currentNodeIndex + 1);
                        setTimeout(() => { isTransitioning = false; }, transitionDelay);
                    } else if (deltaX < 0 && currentNodeIndex > 0) {
                        isTransitioning = true;
                        activateNode(currentNodeIndex - 1);
                        setTimeout(() => { isTransitioning = false; }, transitionDelay);
                    }
                } else {
                    // 纵向滚动也支持（向下=下一个，向上=上一个）
                    if (deltaY > 0 && currentNodeIndex < 11) {
                        isTransitioning = true;
                        activateNode(currentNodeIndex + 1);
                        setTimeout(() => { isTransitioning = false; }, transitionDelay);
                    } else if (deltaY < 0 && currentNodeIndex > 0) {
                        isTransitioning = true;
                        activateNode(currentNodeIndex - 1);
                        setTimeout(() => { isTransitioning = false; }, transitionDelay);
                    }
                }
            }, { passive: false });

            // 键盘左右箭头支持
            const handleKeyPress = (e) => {
                if (!tomoriMode || tomoriCurrentStage !== 2) return;
                if (isTransitioning) return;
                
                if (e.key === 'ArrowRight' && currentNodeIndex < 11) {
                    isTransitioning = true;
                    activateNode(currentNodeIndex + 1);
                    setTimeout(() => { isTransitioning = false; }, transitionDelay);
                } else if (e.key === 'ArrowLeft' && currentNodeIndex > 0) {
                    isTransitioning = true;
                    activateNode(currentNodeIndex - 1);
                    setTimeout(() => { isTransitioning = false; }, transitionDelay);
                }
            };
            document.addEventListener('keydown', handleKeyPress);

            // 触摸事件 - 支持左右滑动
            ui.tomoriStage2.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            ui.tomoriStage2.addEventListener('touchend', (e) => {
                if (isTransitioning) return;
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                // 判断是横向滑动还是纵向滑动
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    // 横向滑动
                    if (Math.abs(diffX) > swipeThreshold) {
                        if (diffX > 0 && currentNodeIndex < 11) {
                            // 向左滑 = 下一个场景
                            isTransitioning = true;
                            activateNode(currentNodeIndex + 1);
                            setTimeout(() => { isTransitioning = false; }, transitionDelay);
                        } else if (diffX < 0 && currentNodeIndex > 0) {
                            // 向右滑 = 上一个场景
                            isTransitioning = true;
                            activateNode(currentNodeIndex - 1);
                            setTimeout(() => { isTransitioning = false; }, transitionDelay);
                        }
                    }
                } else {
                    // 纵向滑动（保留原有逻辑）
                    if (Math.abs(diffY) > swipeThreshold) {
                        if (diffY > 0 && currentNodeIndex < 11) {
                            // 向上滑 = 下一个场景
                            isTransitioning = true;
                            activateNode(currentNodeIndex + 1);
                            setTimeout(() => { isTransitioning = false; }, transitionDelay);
                        } else if (diffY < 0 && currentNodeIndex > 0) {
                            // 向下滑 = 上一个场景
                            isTransitioning = true;
                            activateNode(currentNodeIndex - 1);
                            setTimeout(() => { isTransitioning = false; }, transitionDelay);
                        }
                    }
                }
            }, { passive: true });

            // 鼠标拖拽支持（PC端）
            let mouseStartX = 0;
            let isDraggingScene = false;
            
            ui.tomoriStage2.addEventListener('mousedown', (e) => {
                // 忽略按钮点击
                if (e.target.closest('button') || e.target.closest('.nav-dot')) return;
                
                mouseStartX = e.clientX;
                isDraggingScene = true;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDraggingScene) return;
                // 可以在这里添加拖拽视觉反馈
            });

            document.addEventListener('mouseup', (e) => {
                if (!isDraggingScene) return;
                isDraggingScene = false;
                
                if (isTransitioning) return;
                
                const mouseEndX = e.clientX;
                const diffX = mouseStartX - mouseEndX;
                
                if (Math.abs(diffX) > swipeThreshold) {
                    if (diffX > 0 && currentNodeIndex < 11) {
                        // 向左拖 = 下一个场景
                        isTransitioning = true;
                        activateNode(currentNodeIndex + 1);
                        setTimeout(() => { isTransitioning = false; }, transitionDelay);
                    } else if (diffX < 0 && currentNodeIndex > 0) {
                        // 向右拖 = 上一个场景
                        isTransitioning = true;
                        activateNode(currentNodeIndex - 1);
                        setTimeout(() => { isTransitioning = false; }, transitionDelay);
                    }
                }
            });
            
            // 标记事件监听器已注册
            interactionListenersAdded = true;
        }

        let autoEnterTimer = null;
        let autoEnterCountdown = 10;

        function enterTomoriMode() {
            if (tomoriMode) return;
            tomoriMode = true;
            tomoriCurrentStage = 1;
            autoEnterCountdown = 10;
            handGestureDetected = false; // 重置手势检测标志，确保自动倒数可以生效
            console.log("🌌 进入Tomori模式 - 第一幕已开启");
            console.log("📹 请对摄像头比V手势以对焦（10秒后自动进入）");

            // 切换到danxiangsi.mp3音乐
            switchToTomoriMusic();

            // 显示友利宇宙
            ui.tomoriUniverse.style.display = 'flex';
            ui.tomoriUniverse.classList.remove('hidden');
            setTimeout(() => {
                ui.tomoriUniverse.classList.add('active');
            }, 50);
            
            // 蛋糕层淡出并禁用交互
            document.body.classList.add('tomori-mode');

            // 第一幕：摄像机取景框
            ui.tomoriStage1.classList.remove('hidden');
            ui.tomoriStage2.classList.add('hidden');
            
            // 初始化第一幕
            setTimeout(() => {
                initBlurField();
                updateDateTimeDisplay();
                setInterval(updateDateTimeDisplay, 1000);
                ui.focusHint.classList.remove('hidden');
                ui.focusMessage.classList.remove('active');
                
                // 显示手势调试面板
                if (ui.gestureDebugPanel) {
                    ui.gestureDebugPanel.style.display = 'block';
                }
                
                // 启动10秒自动进入倒计时
                startAutoEnterCountdown();
            }, 100);

            // 隐藏重入按钮
            ui.tomoriReEnterBtn.style.display = 'none';
            
            // 设置第二幕交互
            setupStoryCardInteraction();
        }

        function startAutoEnterCountdown() {
            // 清除之前的倒计时
            if (autoEnterTimer) {
                clearInterval(autoEnterTimer);
            }
            
            autoEnterCountdown = 10;
            
            // 在提示文本中显示倒计时
            const updateCountdownText = () => {
                if (ui.focusHint && tomoriCurrentStage === 1) {
                    const originalText = '对摄像头比个 ✌ 对焦进入故事';
                    ui.focusHint.innerHTML = `${originalText}<br><span style="font-size: 0.8em; color: #fbbf24;">${autoEnterCountdown}秒后自动进入</span>`;
                }
            };
            
            updateCountdownText();
            
            autoEnterTimer = setInterval(() => {
                autoEnterCountdown--;
                
                if (autoEnterCountdown <= 0) {
                    clearInterval(autoEnterTimer);
                    autoEnterTimer = null;
                    
                    // 如果还没检测到手势且仍在第一幕，自动进入第二幕
                    if (tomoriMode && tomoriCurrentStage === 1 && !handGestureDetected) {
                        console.log("⏰ 倒计时结束，自动进入第二幕");
                        handGestureDetected = true;
                        ui.focusHint.classList.add('hidden');
                        ui.focusMessage.innerHTML = '✨ 自动进入故事世界...';
                        ui.focusMessage.classList.add('active');
                        setTimeout(() => {
                            transitionToStage2();
                        }, 1500);
                    }
                } else {
                    updateCountdownText();
                }
            }, 1000);
        }

        function exitTomoriMode() {
            if (!tomoriMode) return;
            tomoriMode = false;
            handGestureDetected = false; // 重置手势检测标志

            // 停止所有动画
            if (tomoriStarfieldAnimationId) {
                cancelAnimationFrame(tomoriStarfieldAnimationId);
                tomoriStarfieldAnimationId = null;
            }
            if (tomoriBlurFieldAnimationId) {
                cancelAnimationFrame(tomoriBlurFieldAnimationId);
                tomoriBlurFieldAnimationId = null;
            }

            // 隐藏友利宇宙（淡出）
            ui.tomoriUniverse.classList.remove('active');
            setTimeout(() => {
                ui.tomoriUniverse.classList.add('hidden');
                ui.tomoriUniverse.style.display = 'none';
            }, 800);

            // 蛋糕层淡入并恢复交互
            document.body.classList.remove('tomori-mode');

            // 延迟后显示重入按钮和烟花按钮
            setTimeout(() => {
                ui.tomoriReEnterBtn.style.display = 'flex';
                if (ui.fireworksBtn) {
                    ui.fireworksBtn.style.display = 'block';
                }
            }, 800);
            
            // 不重置音乐，继续播放当前曲目
        }

        // ===== 音乐控制功能 =====
        let isMusicPlaying = true;
        
        function switchToTomoriMusic() {
            console.log('🎵 切换音乐到 danxiangsi.mp3');
            
            // 暂停当前音乐
            bgm.pause();
            
            // 切换到danxiangsi.mp3
            bgm.src = './src/danxiangsi.mp3';
            bgm.load();
            
            // 播放新音乐
            bgm.play().then(() => {
                console.log('✅ danxiangsi.mp3 已开始播放');
                isMusicPlaying = true;
                updateMusicButtonState();
            }).catch(err => {
                console.warn('⚠️ 音乐自动播放被阻止，请点击音乐按钮手动播放', err);
                isMusicPlaying = false;
                updateMusicButtonState();
            });
        }
        
        function updateMusicButtonState() {
            if (ui.musicControlBtn) {
                if (isMusicPlaying) {
                    ui.musicControlBtn.textContent = '🎵';
                    ui.musicControlBtn.classList.remove('muted');
                    ui.musicControlBtn.title = '点击关闭音乐';
                } else {
                    ui.musicControlBtn.textContent = '🔇';
                    ui.musicControlBtn.classList.add('muted');
                    ui.musicControlBtn.title = '点击播放音乐';
                }
            }
        }
        
        // 音乐控制按钮事件
        if (ui.musicControlBtn) {
            ui.musicControlBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                if (isMusicPlaying) {
                    bgm.pause();
                    isMusicPlaying = false;
                    console.log('🔇 音乐已暂停');
                } else {
                    bgm.play().then(() => {
                        isMusicPlaying = true;
                        console.log('🎵 音乐已播放');
                    }).catch(err => {
                        console.warn('⚠️ 音乐播放失败', err);
                    });
                }
                
                updateMusicButtonState();
            });
        }

        // ===== 彩蛋功能 =====
        // 心情急救包
        if (ui.heartfeltAidBtn) {
            ui.heartfeltAidBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('🩹 心情急救包已触发！');
                
                // 屏幕震动效果
                document.body.style.animation = 'none';
                setTimeout(() => {
                    document.body.style.animation = 'shake-screen 0.5s';
                }, 10);
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 600);
                
                // 强制重新加载GIF（从头播放）
                const gifImg = ui.heartfeltAidPopup.querySelector('.aid-animation img');
                if (gifImg) {
                    const originalSrc = gifImg.src.split('?')[0]; // 移除可能存在的时间戳
                    gifImg.src = originalSrc + '?t=' + Date.now(); // 添加时间戳强制刷新
                }
                
                // 重置动画（强制重新播放）
                const aidContent = ui.heartfeltAidPopup.querySelector('.aid-content');
                const aidAnimation = ui.heartfeltAidPopup.querySelector('.aid-animation');
                
                if (aidContent) {
                    aidContent.style.animation = 'none';
                    setTimeout(() => {
                        aidContent.style.animation = '';
                    }, 10);
                }
                
                if (aidAnimation) {
                    aidAnimation.style.animation = 'none';
                    setTimeout(() => {
                        aidAnimation.style.animation = '';
                    }, 10);
                }
                
                // 显示弹窗
                ui.heartfeltAidPopup.classList.remove('hidden');
                ui.heartfeltAidPopup.classList.add('active');
                
                // 7.2秒后关闭弹窗（确保GIF完整播放一次）
                setTimeout(() => {
                    ui.heartfeltAidPopup.classList.remove('active');
                }, 8200);
            });
        }

        // 万能兑换券
        if (ui.voucherBtn) {
            ui.voucherBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('🎫 无限期陪伴券已触发！');
                
                // 强制重新加载GIF（从头播放）
                const gifImg = ui.voucherPopup.querySelector('.aid-animation img');
                if (gifImg) {
                    const originalSrc = gifImg.src.split('?')[0];
                    gifImg.src = originalSrc + '?t=' + Date.now();
                }
                
                // 重置动画
                const aidContent = ui.voucherPopup.querySelector('.aid-content');
                const aidAnimation = ui.voucherPopup.querySelector('.aid-animation');
                
                if (aidContent) {
                    aidContent.style.animation = 'none';
                    setTimeout(() => {
                        aidContent.style.animation = '';
                    }, 10);
                }
                
                if (aidAnimation) {
                    aidAnimation.style.animation = 'none';
                    setTimeout(() => {
                        aidAnimation.style.animation = '';
                    }, 10);
                }
                
                // 显示弹窗（温柔淡入）
                ui.voucherPopup.classList.remove('hidden');
                ui.voucherPopup.classList.add('active');
                
                // 5秒后关闭弹窗
                setTimeout(() => {
                    ui.voucherPopup.classList.remove('active');
                }, 6000);
            });
        }

        // 下载陪伴券按钮
        if (ui.downloadVoucherBtn) {
            ui.downloadVoucherBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                generateVoucher();
            });
        }

        function generateVoucher() {
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');

            // 背景
            const gradient = ctx.createLinearGradient(0, 0, 600, 400);
            gradient.addColorStop(0, '#0f172a');
            gradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 600, 400);

            // 边框
            ctx.strokeStyle = '#a78bfa';
            ctx.lineWidth = 3;
            ctx.strokeRect(20, 20, 560, 360);

            // 标题
            ctx.fillStyle = '#fbbf24';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('【无限期陪伴券】', 300, 80);

            // 内容
            ctx.fillStyle = '#e2e8f0';
            ctx.font = '18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('持有者：zj', 300, 150);
            ctx.fillText('发行者：ycx', 300, 190);
            ctx.fillText('效力：无论何时何地', 300, 240);
            ctx.fillText('此券可兑换"无条件的陪伴"一次', 300, 280);
            
            ctx.fillStyle = '#a78bfa';
            ctx.font = 'italic 16px Arial';
            ctx.fillText('就像友利奈绪对乙坂有宇那样。', 300, 340);

            // 下载
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = '无限期陪伴券.png';
            link.click();
            
            console.log('📥 陪伴券已下载');
        }

        // ===== 事件监听器 =====
        if (ui.enterTomoriBtn) {
            ui.enterTomoriBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // 先收起卡片
                ui.closeBtn.click();
                // 延迟后进入友利模式
                setTimeout(() => enterTomoriMode(), 500);
            });
        }

        if (ui.tomoriReturnBtn2) {
            ui.tomoriReturnBtn2.addEventListener('click', (e) => {
                e.stopPropagation();
                exitTomoriMode();
            });
        }

        if (ui.tomoriReEnterBtn) {
            ui.tomoriReEnterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                enterTomoriMode();
            });
        }

        // ===== 烟花大会功能（重构版本）=====
        const fireworksBlessings = [
            '🎉🎉🎉🎉',
            '流水今日\n明月前身',
            '不念不惧\n永葆天真',
            '一生无忧\n眉眼带笑',
            '管他几岁\n开心万岁',
            '平安无疾\n前程似锦',
            '祝小仙女\n生日快乐',
            '身体健康',
            '自由暴富',
            '事业顺遂',
            '狂吃不胖',
            '平安喜乐',
            '家庭和睦',
            '万事胜意',     
            '永远美丽',
            '一直陪你',
            '愿时光\n待你以温柔\n岁月\n予你以静好',
            '往后余生\n平安健康\n喜乐无忧',
            '愿一切美好\n都比你期待\n还要好上\n一点点',
            '希望温暖和爱\n一直陪伴\n在你身边',
            '新的起点\n前方皆是坦途\n未来充满希望',
            '时光不老\n我们不散\n情谊常在心间',
            '新的一岁\n愿你依旧\n温暖如初\n闪闪发光',
            '愿你的事业\n乘风破浪\n收获满满成就',
            '愿好运常伴\n机遇频现\n梦想皆可实现',
            '愿你享受\n美食无忧\n保持健康活力',
            '愿你有说走\n就走的勇气\n也有享受\n旅途的心情',
            '愿你有能做\n自己的自由\n和敢做自己\n的胆量',
            '愿你的生活\n充满小确幸\n对未来永远\n充满期待',
            '愿生活给你\n满满的\n甜蜜惊喜\n快乐加倍'
        ];

        let fireworksAnimationId = null;
        let bigBooms = [];
        let stars = [];
        let blessingIndex = 0;
        let hasActiveTextFirework = false;
        let lastTextFireworkTime = 0;
        let lastFireworkTime = 0;
        let offscreenCanvas = null;
        let offscreenCtx = null;

        // 工具函数
        function getRandom(a, b) {
            return Math.random() * (b - a) + a;
        }

        // 星星背景类
        class Star {
            constructor(x, y, r) {
                this.x = x;
                this.y = y;
                this.r = r;
            }
            
            paint(ctx) {
                ctx.save();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
                ctx.fillStyle = `rgba(255,255,255,${this.r})`;
                ctx.fill();
                ctx.restore();
            }
        }

        // 烟花碎片类
        class Frag {
            constructor(centerX, centerY, radius, color, tx, ty, isTextParticle = false) {
                this.tx = tx;
                this.ty = ty;
                this.x = centerX;
                this.y = centerY;
                this.dead = false;
                this.centerX = centerX;
                this.centerY = centerY;
                // 文字粒子适度增大1.2倍，保持纤细清晰
                this.radius = isTextParticle ? radius * 1.2 : radius;
                this.color = color;
                this.lifeTime = 0;
                this.isTextParticle = isTextParticle;
            }

            paint(ctx) {
                ctx.save();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
                ctx.fillStyle = `rgba(${this.color.a},${this.color.b},${this.color.c},1)`;
                ctx.fill();
                ctx.restore();
            }

            moveTo(ctx, isTextParticle) {
                this.ty = this.ty + 0.25;
                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                this.x = Math.abs(dx) < 0.1 ? this.tx : this.x + dx * 0.1;
                this.y = Math.abs(dy) < 0.1 ? this.ty : this.y + dy * 0.1;
                this.lifeTime++;

                // 文字粒子1秒消失（60帧），普通粒子80帧
                const maxLife = isTextParticle ? 60 : 80;
                if (dx === 0 && Math.abs(dy) <= 100 && this.lifeTime > maxLife) {
                    this.dead = true;
                }
                
                // 文字粒子添加发光效果，手机端加强让文字更清晰
                if (isTextParticle) {
                    ctx.save();
                    const glowSize = IS_MOBILE ? 12 : 6;
                    ctx.shadowBlur = glowSize;
                    ctx.shadowColor = `rgba(${this.color.a},${this.color.b},${this.color.c},0.6)`;
                    this.paint(ctx);
                    ctx.restore();
                } else {
                    this.paint(ctx);
                }
            }
        }

        // 烟花主体类
        class Boom {
            constructor(x, r, c, boomArea, blessingText) {
                this.booms = [];
                this.x = x;
                this.y = ui.fireworksCanvas.height + r;
                this.r = r;
                this.c = c;
                this.blessingText = blessingText || null;
                this.boomArea = boomArea;
                this.theta = 0;
                this.dead = false;
                this.ba = parseInt(getRandom(80, 200));
            }

            _paint(ctx) {
                ctx.save();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
                ctx.fillStyle = this.c;
                ctx.fill();
                ctx.restore();
            }

            _move(ctx) {
                const dx = this.boomArea.x - this.x;
                const dy = this.boomArea.y - this.y;
                // 加快上升速度，从0.01改为0.03
                this.x = this.x + dx * 0.03;
                this.y = this.y + dy * 0.03;

                if (Math.abs(dx) <= this.ba && Math.abs(dy) <= this.ba) {
                    if (this.blessingText) {
                        console.log('触发文字烟花爆炸:', this.blessingText);
                        this._textBoom();
                    } else {
                        this._boom();
                    }
                    this.dead = true;
                } else {
                    this._paint(ctx);
                }
            }

            _drawLight(ctx) {
                ctx.save();
                ctx.fillStyle = 'rgba(255,228,150,0.3)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r + 3 * Math.random() + 1, 0, 2 * Math.PI);
                ctx.fill();
                ctx.restore();
            }

            _boom() {
                // 减少普通烟花粒子数量，从30-200降到20-100
                const fragNum = getRandom(20, 100);
                const style = getRandom(0, 10) >= 5 ? 1 : 2;
                let color;
                if (style === 1) {
                    color = {
                        a: parseInt(getRandom(128, 255)),
                        b: parseInt(getRandom(128, 255)),
                        c: parseInt(getRandom(128, 255))
                    };
                }
                // 减小爆炸范围，从300-400降到250-350
                const fanwei = parseInt(getRandom(250, 350));
                
                for (let i = 0; i < fragNum; i++) {
                    if (style === 2) {
                        color = {
                            a: parseInt(getRandom(128, 255)),
                            b: parseInt(getRandom(128, 255)),
                            c: parseInt(getRandom(128, 255))
                        };
                    }
                    const a = getRandom(-Math.PI, Math.PI);
                    const x = getRandom(0, fanwei) * Math.cos(a) + this.x;
                    const y = getRandom(0, fanwei) * Math.sin(a) + this.y;
                    const radius = getRandom(0, 2);
                    const frag = new Frag(this.x, this.y, radius, color, x, y);
                    this.booms.push(frag);
                }
            }

            _textBoom() {
                if (!offscreenCanvas || !offscreenCtx) {
                    console.error('离屏Canvas未初始化');
                    return;
                }
                
                const canvas = offscreenCanvas;
                const ctx = offscreenCtx;
                
                console.log('生成文字烟花:', this.blessingText);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 手机端字体适中，确保不超出屏幕
                const baseSize = IS_MOBILE ? 0.12 : 0.08;
                const fontSize = Math.min(window.innerWidth, window.innerHeight) * baseSize;
                const minSize = IS_MOBILE ? 60 : 40;
                const maxSize = IS_MOBILE ? 120 : 100;
                const finalFontSize = Math.max(minSize, Math.min(fontSize, maxSize));
                
                ctx.save();
                // 手机端使用bold字重，确保文字清晰可见
                ctx.font = `bold ${finalFontSize}px 楷体, KaiTi, STKaiti, serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = `rgba(${parseInt(getRandom(128, 255))},${parseInt(getRandom(128, 255))},${parseInt(getRandom(128, 255))},1)`;
                
                const textLines = this.blessingText.split('\n');
                const lineHeight = finalFontSize * 1.5;
                const totalHeight = textLines.length * lineHeight;
                const startY = canvas.height / 2 - totalHeight / 2 + lineHeight / 2;
                
                for (let i = 0; i < textLines.length; i++) {
                    const y = startY + i * lineHeight;
                    const x = canvas.width / 2 + (i - Math.floor(textLines.length / 2)) * 20;
                    ctx.fillText(textLines[i], x, y);
                }
                
                ctx.restore();
                
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 手机端减小采样间隔，增加粒子密度让文字更清晰
                const dr = IS_MOBILE ? 4 : 6;
                let particleCount = 0;
                for (let x = 0; x < imgData.width; x += dr) {
                    for (let y = 0; y < imgData.height; y += dr) {
                        const i = (y * imgData.width + x) * 4;
                        if (imgData.data[i + 3] > 128) {
                            // 适度增强颜色亮度，保持层次
                            const color = {
                                a: Math.min(255, imgData.data[i] + 30),
                                b: Math.min(255, imgData.data[i + 1] + 30),
                                c: Math.min(255, imgData.data[i + 2] + 30)
                            };
                            const dx = ui.fireworksCanvas.width / 2 - this.x;
                            const dy = ui.fireworksCanvas.height / 2 - this.y;
                            // 手机端增大粒子尺寸，确保文字清晰可见
                            const baseRadius = IS_MOBILE ? 1.5 : 1.0;
                            const frag = new Frag(this.x, this.y, baseRadius, color, x - dx, y - dy, true);
                            this.booms.push(frag);
                            particleCount++;
                        }
                    }
                }
                console.log('文字烟花粒子数:', particleCount);
            }
        }

        // 绘制星空背景
        function drawStarsBg(ctx, canvas) {
            stars.forEach(star => star.paint(ctx));
        }

        // 烟花动画主循环
        function animateFireworks() {
            const canvas = ui.fireworksCanvas;
            const ctx = canvas.getContext('2d');
            
            // 半透明背景实现拖尾效果
            ctx.save();
            ctx.fillStyle = 'rgba(0, 5, 24, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();

            const newTime = Date.now();
            
            // 自动发射烟花逻辑 - 缩短间隔增加发射频率
            if (newTime - lastFireworkTime > 100 + (window.innerHeight - 767) / 10) {
                // 文字烟花优先，且激活期间不发射普通烟花
                if (!hasActiveTextFirework && newTime - lastTextFireworkTime > 400) {
                    const shouldBeText = Math.random() * 100 > 60; // 40%概率发射文字烟花
                    
                    if (shouldBeText) {
                        // 文字烟花
                        const blessing = fireworksBlessings[blessingIndex % fireworksBlessings.length];
                        console.log('发射文字烟花:', blessing);
                        const bigboom = new Boom(
                            getRandom(canvas.width / 3, canvas.width * 2 / 3),
                            2,
                            '#FFF',
                            {
                                x: getRandom(canvas.width / 4, canvas.width * 3 / 4),
                                y: getRandom(150, 300)
                            },
                            blessing
                        );
                        bigBooms.push(bigboom);
                        blessingIndex++;
                        hasActiveTextFirework = true;
                        lastFireworkTime = newTime;
                    } else {
                        // 普通烟花 - 每次发射2-3个
                        const count = Math.floor(getRandom(2, 4));
                        for (let i = 0; i < count; i++) {
                            const x = getRandom(canvas.width / 5, canvas.width * 4 / 5);
                            const y = getRandom(50, 200);
                            const bigboom = new Boom(
                                getRandom(canvas.width / 3, canvas.width * 2 / 3),
                                2,
                                '#FFF',
                                { x: x, y: y }
                            );
                            bigBooms.push(bigboom);
                        }
                        lastFireworkTime = newTime;
                    }
                } else if (!hasActiveTextFirework) {
                    // 文字烟花显示期间，也发射普通烟花增加热闹效果
                    if (Math.random() > 0.6) { // 40%概率发射
                        const count = Math.floor(getRandom(1, 3));
                        for (let i = 0; i < count; i++) {
                            const x = getRandom(canvas.width / 5, canvas.width * 4 / 5);
                            const y = getRandom(50, 200);
                            const bigboom = new Boom(
                                getRandom(canvas.width / 3, canvas.width * 2 / 3),
                                2,
                                '#FFF',
                                { x: x, y: y }
                            );
                            bigBooms.push(bigboom);
                        }
                    }
                    lastFireworkTime = newTime;
                }
            }

            // 绘制星星背景
            drawStarsBg(ctx, canvas);

            // 更新和绘制烟花
            bigBooms.forEach((boom, index) => {
                if (!boom.dead) {
                    boom._move(ctx);
                    boom._drawLight(ctx);
                } else {
                    let allDead = true;
                    let activeFrags = 0;
                    const isTextBoom = !!boom.blessingText;
                    boom.booms.forEach((frag, fragIndex) => {
                        if (!frag.dead) {
                            frag.moveTo(ctx, frag.isTextParticle);
                            allDead = false;
                            activeFrags++;
                        }
                    });
                    
                    if (allDead) {
                        if (boom.blessingText) {
                            console.log('文字烟花完全消失');
                        }
                        bigBooms[index] = null;
                        if (boom.blessingText) {
                            hasActiveTextFirework = false;
                            lastTextFireworkTime = Date.now();
                        }
                    }
                }
            });

            // 清理null元素
            bigBooms = bigBooms.filter(b => b !== null);

            fireworksAnimationId = requestAnimationFrame(animateFireworks);
        }

        // 初始化星空背景
        function initFireworksStars(canvas) {
            stars = [];
            const maxRadius = 1;
            for (let i = 0; i < 100; i++) {
                const r = Math.random() * maxRadius;
                const x = Math.random() * canvas.width;
                const y = Math.random() * 2 * canvas.height - canvas.height;
                const star = new Star(x, y, r);
                stars.push(star);
            }
        }

        // 进入烟花大会
        function enterFireworksMode() {
            console.log('🎆 进入烟花大会');
            
            // 如果在Tomori模式下，先退出
            if (tomoriMode) {
                console.log('从Tomori模式退出到花火大会');
                // 隐藏Tomori宇宙
                ui.tomoriUniverse.classList.add('hidden');
                tomoriMode = false;
            }
            
            // 显示烟花场景
            ui.fireworksScene.classList.remove('hidden');
            setTimeout(() => {
                ui.fireworksScene.classList.add('active');
            }, 50);
            
            // 初始化Canvas
            const canvas = ui.fireworksCanvas;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // 创建离屏Canvas用于文字渲染
            offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = canvas.width;
            offscreenCanvas.height = canvas.height;
            offscreenCtx = offscreenCanvas.getContext('2d');
            
            // 重置数据
            bigBooms = [];
            blessingIndex = 0;
            hasActiveTextFirework = false;
            lastTextFireworkTime = 0;
            lastFireworkTime = Date.now();
            
            // 初始化星空背景
            initFireworksStars(canvas);
            
            // 先绘制初始背景
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(0, 5, 24, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawStarsBg(ctx, canvas);
            
            // 启动动画
            animateFireworks();
            
            // 隐藏烟花按钮
            if (ui.fireworksBtn) {
                ui.fireworksBtn.style.display = 'none';
            }
        }

        // 退出烟花大会
        function exitFireworksMode() {
            console.log('🎉 退出烟花大会');
            
            // 停止动画
            if (fireworksAnimationId) {
                cancelAnimationFrame(fireworksAnimationId);
                fireworksAnimationId = null;
            }
            
            // 清理数据
            bigBooms = [];
            stars = [];
            offscreenCanvas = null;
            offscreenCtx = null;
            
            // 移除tomori-mode类（如果存在）
            document.body.classList.remove('tomori-mode');
            
            // 隐藏场景
            ui.fireworksScene.classList.remove('active');
            setTimeout(() => {
                ui.fireworksScene.classList.add('hidden');
            }, 800);
            
            // 恢复蛋糕界面
            interactionMode = 1;
            transitionTo('cake');
            ui.statusText.innerText = "INTERACTIVE MODE: DRAG TO ROTATE";
            ui.topBanner.classList.remove('hidden');
            
            // 确保UI层和canvas容器可见
            if (ui.uiLayer) {
                ui.uiLayer.style.display = 'flex';
                ui.uiLayer.style.opacity = '1';
                ui.uiLayer.style.pointerEvents = 'auto';
            }
            const canvasContainer = document.getElementById('canvas-container');
            if (canvasContainer) {
                canvasContainer.style.opacity = '1';
                canvasContainer.style.pointerEvents = 'auto';
            }
            
            // 显示按钮
            ui.floatingGiftBtn.classList.remove('hidden');
            ui.tomoriReEnterBtn.style.display = 'flex';
            if (ui.fireworksBtn) {
                ui.fireworksBtn.style.display = 'flex';
            }
        }

        // 烟花按钮事件
        if (ui.fireworksBtn) {
            ui.fireworksBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                enterFireworksMode();
            });
        }

        // 烟花返回按钮事件
        if (ui.fireworksReturnBtn) {
            ui.fireworksReturnBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exitFireworksMode();
            });
        }

        // 花火大会音乐按钮事件
        if (ui.fireworksMusicBtn) {
            ui.fireworksMusicBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (bgm.paused) {
                    bgm.play();
                    ui.fireworksMusicBtn.textContent = '🎵';
                } else {
                    bgm.pause();
                    ui.fireworksMusicBtn.textContent = '🔇';
                }
            });
        }

        // 响应式适配
        window.addEventListener('resize', () => {
            if (tomoriMode && tomoriCurrentStage === 1 && ui.tomoriBlurField) {
                ui.tomoriBlurField.width = window.innerWidth;
                ui.tomoriBlurField.height = window.innerHeight;
            }
            if (tomoriMode && tomoriCurrentStage === 2 && ui.tomoriStarfieldMain) {
                ui.tomoriStarfieldMain.width = window.innerWidth;
                ui.tomoriStarfieldMain.height = window.innerHeight;
            }
            // 烟花场景响应式
            if (ui.fireworksScene && !ui.fireworksScene.classList.contains('hidden')) {
                ui.fireworksCanvas.width = window.innerWidth;
                ui.fireworksCanvas.height = window.innerHeight;
                
                // 更新离屏Canvas尺寸
                if (offscreenCanvas) {
                    offscreenCanvas.width = window.innerWidth;
                    offscreenCanvas.height = window.innerHeight;
                }
                
                // 重新初始化星空背景
                initFireworksStars(ui.fireworksCanvas);
            }
        });
    </script>
</body>
</html> 